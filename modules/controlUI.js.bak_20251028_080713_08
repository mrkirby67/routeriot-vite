// ============================================================================
// MODULE: controlUI.js (UPDATED)
// Purpose: Wire up UI buttons and trigger controlActions
// Now integrates with clearAllChatAndScores() from controlStatus.js
// ============================================================================

import { showCountdownBanner, showFlashMessage } from './gameUI.js';
import { pauseGame, resumeGame, releaseZones } from './gameStateManager.js';
import { safelyEndGameAndResetZones, resetFullGameState } from './controlActions.js';
import { clearAllChatAndScores } from './controlStatus.js'; // ‚úÖ NEW IMPORT
import { db } from '../../modules/config.js';
import {
  doc, getDoc, updateDoc, addDoc, collection, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const GAME_STATE_REF = doc(db, "game", "gameState");
const DEFAULT_DURATION_MIN = 30;

export function wireGameControls() {
  const startBtn   = document.getElementById('start-btn');
  const pauseBtn   = document.getElementById('pause-btn');
  const releaseBtn = document.getElementById('release-zones-btn');
  const endBtn     = document.getElementById('end-btn');
  const resetBtn   = document.getElementById('reset-game-btn');
  const clearBtn   = document.getElementById('clear-scores-btn'); // üßπ "Clear All"

  // üèÅ START GAME
  if (startBtn) {
    startBtn.addEventListener('click', async () => {
      try {
        await clearAllChatAndScores(); // üßπ Clears everything before starting
        const snap = await getDoc(GAME_STATE_REF);
        const existing = snap.exists() ? snap.data() : {};

        const update = {
          status: 'active',
          zonesReleased: true,
          updatedAt: serverTimestamp(),
        };
        if (!existing.startTime) update.startTime = serverTimestamp();
        if (!existing.durationMinutes) update.durationMinutes = DEFAULT_DURATION_MIN;

        await updateDoc(GAME_STATE_REF, update);
        await addDoc(collection(db, "communications"), {
          teamName: "Game Master",
          sender: "Game Master",
          senderDisplay: "Game Master",
          message: "üèÅ A new game has begun! Scoreboard cleared, chat wiped, and zones live.",
          isBroadcast: true,
          timestamp: serverTimestamp(),
        });

        showCountdownBanner({ parent: document.body });
        showFlashMessage('‚úÖ Game Started! Everything cleared and ready.', '#2e7d32', 3000);
      } catch (e) {
        console.error('Error starting game:', e);
        showFlashMessage('Start failed.', '#c62828', 2500);
      }
    });
  }

  // ‚è∏Ô∏è / ‚ñ∂Ô∏è TOGGLE PAUSE-RESUME
  if (pauseBtn) {
    pauseBtn.addEventListener('click', async () => {
      try {
        const snap = await getDoc(GAME_STATE_REF);
        const data = snap.exists() ? snap.data() : {};
        const isPaused = data.status === 'paused';

        if (isPaused) {
          await resumeGame();
          pauseBtn.textContent = 'Pause Game';
          showFlashMessage('‚ñ∂Ô∏è Game Resumed!', '#2e7d32', 2500);
        } else {
          await pauseGame();
          pauseBtn.textContent = 'Resume Game';
          showFlashMessage('‚è∏Ô∏è Game Paused!', '#ff9800', 2500);
        }
      } catch (e) {
        console.error('Pause/Resume error:', e);
        showFlashMessage('Pause/Resume failed.', '#c62828', 2500);
      }
    });
  }

  // üåç RELEASE ZONES
  if (releaseBtn) {
    releaseBtn.addEventListener('click', async () => {
      try {
        await releaseZones();
        showFlashMessage('Zones Released!', '#1976d2', 3000);
      } catch (e) {
        console.error('Error releasing zones:', e);
        showFlashMessage('Zone release failed.', '#c62828', 2500);
      }
    });
  }

  // üèÅ END GAME
  if (endBtn) {
    endBtn.addEventListener('click', async () => {
      try {
        await safelyEndGameAndResetZones();
        showFlashMessage('üèÅ Game Ended! Zones reset.', '#c62828', 4000);
        pauseBtn.textContent = 'Pause Game';
      } catch (e) {
        console.error('Error ending game:', e);
        showFlashMessage('End failed.', '#c62828', 2500);
      }
    });
  }

  // üîÑ RESET GAME STATE
  if (resetBtn) {
    resetBtn.addEventListener('click', async () => {
      if (confirm('Reset game state to WAITING and clear all scoreboard data (scores + locations)?')) {
        await resetFullGameState();
        pauseBtn.textContent = 'Pause Game';
        showFlashMessage('üîÑ Game fully reset.', '#757575', 3000);
      }
    });
  }

  // üßπ CLEAR EVERYTHING (chat + scores + zones + team statuses)
  if (clearBtn) {
    clearBtn.addEventListener('click', async () => {
      if (confirm('‚ö†Ô∏è This will clear ALL chat, scores, zones, and team statuses. Continue?')) {
        try {
          await clearAllChatAndScores();
          showFlashMessage('üßπ All chat, scores, and team statuses cleared.', '#1565c0', 4000);
        } catch (err) {
          console.error('Error clearing data:', err);
          showFlashMessage('‚ùå Clear failed.', '#c62828', 2500);
        }
      }
    });
  }
}
