// ============================================================================
// FILE: /modules/zones.js
// PURPOSE: Orchestrates zone rendering, listeners, and challenge flow (Player View)
// ============================================================================

import { db } from '../../modules/config.js';
import {
  doc,
  onSnapshot,
  collection,
  getDoc,
  getDocs,
  query,
  orderBy,
  limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import { waitForElement, flashPlayerLocation, playRaceStartSequence, calculateDistance } from '../../modules/zonesUtils.js';
import { generateMiniMap } from './zonesMap.js';
import { displayZoneQuestions, setTeamContext } from './zonesChallenge.js';
import { broadcastChallenge } from './zonesFirestore.js';
import { updateControlledZones } from '../../modules/scoreboardManager.js';
import { startConfetti, stopConfetti } from './playerUI.js';
import { allTeams } from '../../modules/data.js';

let zonesLocked = true;
let currentTeamName = null;
const zoneListenerRegistry = new Set();

function registerZoneListener(label, unsub) {
  if (typeof unsub !== 'function') return;
  zoneListenerRegistry.add({ label, unsub });
  console.info(`ğŸ“¡ [zones] attached listener â†’ ${label}`);
}

function clearZoneListeners(reason = 'manual') {
  if (!zoneListenerRegistry.size) return;
  console.info(`ğŸ§¹ [zones] detaching ${zoneListenerRegistry.size} listener(s) (${reason})`);
  for (const entry of zoneListenerRegistry) {
    try {
      entry.unsub?.();
    } catch (err) {
      console.warn(`âš ï¸ [zones] failed to detach listener ${entry.label}:`, err);
    }
  }
  zoneListenerRegistry.clear();
}

export function teardownZonesListeners(reason = 'teardown') {
  clearZoneListeners(reason);
}

/* ---------------------------------------------------------------------------
 * ğŸ§­ INITIALIZE ZONES (Player View)
 * ------------------------------------------------------------------------ */
export async function initializeZones(teamName) {
  clearZoneListeners('reinitialize');
  // Normalize team name
  const teamObj = allTeams.find(t => t.name === teamName);
  currentTeamName = teamObj ? teamObj.name : teamName;
  setTeamContext(currentTeamName);

  const tableBody = await waitForElement('player-zones-tbody');
  const zonesCollection = collection(db, 'zones');

  /* -------------------------------------------------------------------------
   * ğŸ”” LISTEN TO GAME STATE (lock/unlock zones + detect ending)
   * ---------------------------------------------------------------------- */
  registerZoneListener('gameState', onSnapshot(doc(db, 'game', 'gameState'), (gameSnap) => {
    const data = gameSnap.data();
    if (!data?.status) return;

    const wasLocked = zonesLocked;
    const shouldLock = !(data.status === 'active' && data.zonesReleased);

    if (wasLocked && !shouldLock) {
      playRaceStartSequence();
      console.log('ğŸ Race started â€” zones unlocked for challenges!');
    }

    // ğŸ† Detect Game End â†’ Show Top 3 Winners overlay
    if (['finished', 'ended'].includes(data.status)) {
      showFinalStandings();
    }

    zonesLocked = shouldLock;
  }));

  /* -------------------------------------------------------------------------
   * ğŸ—ºï¸ LISTEN TO ALL ZONES (re-render player zone table)
   * ---------------------------------------------------------------------- */
  registerZoneListener('zonesCollection', onSnapshot(zonesCollection, (snapshot) => {
    tableBody.innerHTML = '';

    snapshot.forEach(docSnap => {
      const zone = docSnap.data();
      const zoneId = docSnap.id;

      const statusText =
        zone.status === 'Taken' && zone.controllingTeam
          ? `Controlled by ${zone.controllingTeam}`
          : 'Available';

      const lockedAttr = zonesLocked ? 'disabled' : '';
      const row = document.createElement('tr');
      row.dataset.zoneId = zoneId;
      row.innerHTML = `
        <td>${zone.name || zoneId}</td>
        <td>${generateMiniMap(zone)}</td>
        <td>${statusText}</td>
        <td>
          <button class="challenge-btn" data-zone-id="${zoneId}" ${lockedAttr}>
            ${zonesLocked ? 'ğŸ”’ Locked' : 'ğŸ¯ Challenge'}
          </button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }));

  /* -------------------------------------------------------------------------
   * ğŸ¯ HANDLE CHALLENGE ATTEMPTS
   * ---------------------------------------------------------------------- */
  if (!tableBody._listenerAttached) {
    tableBody.addEventListener('click', async (e) => {
      if (!e.target.classList.contains('challenge-btn') || zonesLocked) return;

      const zoneId = e.target.dataset.zoneId;
      try {
        const zoneDoc = await getDoc(doc(db, 'zones', zoneId));
        if (!zoneDoc.exists()) {
          alert('âš ï¸ Zone data not found.');
          return;
        }

        const zoneData = zoneDoc.data();
        if (!zoneData?.gps) {
          alert('âš ï¸ Zone missing GPS coordinates.');
          return;
        }

        const [targetLat, targetLng] = zoneData.gps.split(',').map(Number);
        const targetRadiusKm = (parseFloat(zoneData.diameter) || 0.05) / 2;

        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const dist = calculateDistance(
              pos.coords.latitude,
              pos.coords.longitude,
              targetLat,
              targetLng
            );

            if (dist <= targetRadiusKm + pos.coords.accuracy / 1000) {
              console.log(`âœ… ${currentTeamName} reached ${zoneData.name} zone.`);

              await broadcastChallenge(currentTeamName, zoneData.name);
              displayZoneQuestions(zoneId, zoneData.name);

              await updateControlledZones(currentTeamName, zoneData.name);
              console.log(`ğŸ† Zone updated â†’ ${currentTeamName} now controls ${zoneData.name}`);
            } else {
              const kmAway = Math.max(0, dist - targetRadiusKm).toFixed(3);
              alert(`ğŸ“ Getting warmer... ${kmAway} km away.`);
            }
          },
          () => alert('âš ï¸ Could not get your location. Please enable GPS.'),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      } catch (err) {
        console.error('âŒ Challenge error:', err);
        alert('Error attempting challenge. Please try again.');
      }
    });

    tableBody._listenerAttached = true;
  }

  console.info('âœ… [zones] initialization complete');
  return (reason = 'player-cleanup') => clearZoneListeners(reason);
}

/* ---------------------------------------------------------------------------
 * ğŸ GAME OVER HANDLER (Player View)
 * Displays final standings overlay with confetti + 20s timer
 * ------------------------------------------------------------------------ */
async function showFinalStandings() {
  try {
    const topTeamsSnap = await getDocs(
      query(collection(db, "scores"), orderBy("score", "desc"), limit(3))
    );

    const winners = topTeamsSnap.docs.map(docSnap => ({
      name: docSnap.id,
      ...docSnap.data()
    }));

    const title = "ğŸ GAME OVER ğŸ";
    let message = `
      <h2 style='color:gold; font-size:2em; margin-bottom:0;'>ğŸ† Final Standings ğŸ†</h2>
      <ol style='list-style:none; padding:0; margin:10px 0;'>
        ${winners.map((team, i) => {
          const medal = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"][i] || "ğŸ–ï¸";
          return `<li style="font-size:1.4em; margin:6px 0;">${medal} <strong>${team.name}</strong> â€” ${team.score} pts</li>`;
        }).join('')}
      </ol>
    `;

    const overlay = document.createElement("div");
    overlay.id = "game-over-overlay";
    overlay.style.cssText = `
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.92);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      z-index: 99999;
      font-family: system-ui, sans-serif;
      opacity: 0;
      transition: opacity 0.6s ease;
    `;
    overlay.innerHTML = `
      <div>${title}</div>
      <div style="margin-top:10px;">${message}</div>
      <div id="countdown" style="margin-top:20px;font-size:1.3em;">Closing in 20s...</div>
    `;
    document.body.appendChild(overlay);
    requestAnimationFrame(() => (overlay.style.opacity = "1"));

    // ğŸ‰ Confetti celebration
    startConfetti();
    let remaining = 20;
    const countdownEl = overlay.querySelector("#countdown");

    const interval = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(interval);
        stopConfetti();
        overlay.style.opacity = "0";
        setTimeout(() => overlay.remove(), 600);
        flashPlayerLocation("ğŸ‰ Thanks for playing Route Riot!");
      } else {
        countdownEl.textContent = `Closing in ${remaining}s...`;
      }
    }, 1000);
  } catch (err) {
    console.error("âŒ Error showing final standings:", err);
  }
}
