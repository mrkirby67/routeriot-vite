// ============================================================================
// MODULE: diagnostics_flatTireZones.js
// PURPOSE: Non-destructive Firestore scanner for tow zone validation
// ============================================================================

import { db } from '../../modules/config.js';
import {
  collection,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

function normalizeType(value) {
  if (typeof value !== 'string') return '';
  return value.trim().toLowerCase();
}

export async function runFlatTireZoneDiagnostics() {
  console.log('ğŸš¦ [Diagnostics] Checking zones for Flat Tire compatibility...');

  let snapshot;
  try {
    snapshot = await getDocs(collection(db, 'zones'));
  } catch (err) {
    console.error('ğŸ”¥ Diagnostics failed to load zones:', err);
    return;
  }

  if (snapshot.empty) {
    console.warn('âš ï¸ No zones found in Firestore. Flat Tire dropdown will be empty.');
    return;
  }

  let valid = 0;
  let invalid = 0;

  snapshot.forEach((docSnap) => {
    const data = docSnap.data() || {};
    const name = typeof data.zoneName === 'string' && data.zoneName.trim()
      ? data.zoneName.trim()
      : docSnap.id;
    const lat = data.latitude;
    const lng = data.longitude;
    const type = normalizeType(data.type);
    const hasCoords = Number.isFinite(lat) && Number.isFinite(lng);
    const isDepot = type.includes('depot');

    if (hasCoords && isDepot) {
      valid += 1;
      console.log(`âœ… Depot OK â†’ ${name} (${lat}, ${lng})`);
    } else {
      invalid += 1;
      console.warn(
        `âŒ Invalid zone â†’ ${name} â€” type="${data.type ?? 'missing'}", latitude=${lat}, longitude=${lng}`
      );
    }
  });

  console.log(`ğŸ“Š Scan complete â†’ ${valid} depot(s) valid, ${invalid} zone(s) missing requirements.`);
  console.log('ğŸ§© Reminder: Flat Tire dropdown only lists zones with { type: "depot", latitude, longitude }.');
}

// Auto-run when loaded directly
runFlatTireZoneDiagnostics().catch((err) => {
  console.error('ğŸ”¥ Diagnostics run failed:', err);
});
