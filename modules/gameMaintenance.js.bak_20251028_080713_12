// ============================================================================
// FILE: modules/gameMaintenance.js
// PURPOSE: Handles global resets, wipes, and maintenance tasks for Route Riot
// This runs from Control only â€” never from player pages.
// ============================================================================

import { db } from '../../modules/config.js';
import {
  writeBatch,
  getDocs,
  doc,
  collection,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ---------------------------------------------------------------------------
// ğŸ§¹ Reset the entire game (zones, scores, racers, state)
// ---------------------------------------------------------------------------
export async function resetFullGame() {
  if (!confirm('âš ï¸ ARE YOU SURE?\nThis will permanently reset all game data!')) return;
  alert('Resetting game data...');

  try {
    const batch = writeBatch(db);

    // Reset game state
    batch.set(doc(db, 'game', 'gameState'), {
      status: 'not started',
      zonesReleased: false,
      startTime: null,
      endTime: null,
      remainingMs: null,
      durationMinutes: null,
      updatedAt: serverTimestamp()
    });

    // Remove list of active teams
    batch.delete(doc(db, 'game', 'activeTeams'));

    // Reset racers â†’ team: '-'
    const racersSnap = await getDocs(collection(db, 'racers'));
    racersSnap.forEach(r => batch.update(r.ref, { team: '-' }));

    // Reset zones â†’ available
    const zonesSnap = await getDocs(collection(db, 'zones'));
    zonesSnap.forEach(z => batch.update(z.ref, {
      status: 'Available',
      controllingTeam: '',
      lastUpdated: serverTimestamp()
    }));

    // Clear scores
    const scoresSnap = await getDocs(collection(db, 'scores'));
    scoresSnap.forEach(s => batch.delete(s.ref));

    await batch.commit();

    alert('âœ… Game has been fully reset.');
    console.log('ğŸ§¹ All collections reset successfully.');
  } catch (err) {
    console.error('âŒ Reset error:', err);
    alert('An error occurred while resetting. Check console for details.');
  }
}

// ---------------------------------------------------------------------------
// ğŸ§¼ Partial Cleanups (optional, use as needed)
// ---------------------------------------------------------------------------

// Clear only chat + scores
export async function clearChatsAndScores() {
  try {
    const comms = await getDocs(collection(db, 'communications'));
    const scores = await getDocs(collection(db, 'scores'));

    const batch = writeBatch(db);
    comms.forEach(c => batch.delete(c.ref));
    scores.forEach(s => batch.delete(s.ref));

    await batch.commit();
    console.log('ğŸ’¬ğŸ§® Chats and scores cleared.');
  } catch (err) {
    console.error('âŒ Failed to clear chats/scores:', err);
  }
}

// Clear only teamStatus documents
export async function clearTeamStatus() {
  try {
    const teamSnap = await getDocs(collection(db, 'teamStatus'));
    const batch = writeBatch(db);
    teamSnap.forEach(t => batch.delete(t.ref));
    await batch.commit();
    console.log('ğŸ‘¥ Team statuses cleared.');
  } catch (err) {
    console.error('âŒ Failed to clear teamStatus:', err);
  }
}