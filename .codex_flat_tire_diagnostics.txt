ğŸ§­ Running Flat Tire diagnostics...

ğŸ” Import References
===================
components/FlatTireControl/FlatTireControl.js:7: import { createFlatTireControlController } from './flatTireControlController.js';
components/FlatTireControl/controller/autoScheduler.js:4: import { assignFlatTireTeam } from '../../../modules/flatTireManager.js';
components/FlatTireControl/flatTireControlController.js:7: import { loadFlatTireConfig, subscribeFlatTireAssignments, subscribeFlatTireConfig } from '../../modules/flatTireManager.js';
components/FlatTireControl/flatTireControlController_FULL.js:2: // FILE: components/FlatTireControl/flatTireControlController.js
components/FlatTireControl/flatTireControlController_FULL.js:15: __flatTireDefaults,
components/FlatTireControl/flatTireControlController_FULL.js:17: } from '../../modules/flatTireManager.js';
components/FlatTireControl/flatTireControlController_FULL.js:18: import { generateMiniMap } from '../../modules/zonesMap.js';
components/FlatTireControl/flatTireControlController_FULL.js:26: let flatTireControllerBootstrapped = false;
components/FlatTireControl/flatTireControlController_FULL.js:80: zones: JSON.parse(JSON.stringify(__flatTireDefaults.DEFAULT_ZONES)),
components/FlatTireControl/flatTireControlController_FULL.js:81: autoIntervalMinutes: __flatTireDefaults.DEFAULT_AUTO_INTERVAL_MINUTES
components/FlatTireControl/flatTireControlController_FULL.js:106: if (this.initialized || flatTireControllerBootstrapped) {
components/FlatTireControl/flatTireControlController_FULL.js:107: console.info('â„¹ï¸ [flatTireControl] initialize() skipped â€” already active.');
components/FlatTireControl/flatTireControlController_FULL.js:111: flatTireControllerBootstrapped = true;
components/FlatTireControl/flatTireControlController_FULL.js:159: flatTireControllerBootstrapped = false;
components/FlatTireControl/flatTireControlController_FULL.js:161: console.info(`ğŸ§¹ [flatTireControl] destroyed (${reason})`);
components/FlatTireControl/flatTireControlController_FULL.js:361: autoIntervalMinutes: Number.isFinite(autoInterval) && autoInterval > 0 ? autoInterval : __flatTireDefaults.DEFAULT_AUTO_INTERVAL_MINUTES
components/FlatTireControl/flatTireControlController_FULL.js:380: map.innerHTML = generateMiniMap({
components/FlatTireControl/flatTireControlController_FULL.js:471: : this.config.autoIntervalMinutes || __flatTireDefaults.DEFAULT_AUTO_INTERVAL_MINUTES;
components/SurpriseSelector/SurpriseSelector.js:171: const flat = normalizeCount(counts[SurpriseTypes.FLAT_TIRE] ?? counts.flatTire);
components/ZoneManagement/ZoneManagement.js:39: const zonesCollection = collection(db, 'zones');
components/ZoneManagement/ZoneManagement.js:248: unsubscribeZones = onSnapshot(zonesCollection, () => enqueueRender());
control.js:92: const flatTireCleanup = await initializeFlatTireControl();
control.js:93: registerCleanup(flatTireCleanup, 'flatTireControl');
dist/assets/control-Dx2J0vur.js:2: import{db as d,firebaseConfig as Ne,GOOGLE_MAPS_API_KEY as pt}from"./config-DpNrAFUu.js";import{doc as S,onSnapshot as O,getDocs as k,collection as f,writeBatch as Ke,setDoc as M,serverTimestamp as C,addDoc as q,deleteDoc as oe,getDoc as ee,updateDoc as he,query as ve,where as gt,orderBy as we,collectionGroup as ht}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{_ as ce,r as Ve,p as Je,a as de,e as x,g as ft,b as bt,c as yt,s as ie,d as Re,f as vt,h as wt,i as _t,j as Ct,l as St,k as $t,m as Et,n as Me,o as _e,q as Xe,u as Tt,t as et,v as Bt,w as _,x as kt,S as X,y as Lt,z as At,A as It,B as tt,C as Pe,D as $e,E as Ge,G as De,F as ue,H as Mt,I as zt,J as nt,K as xt,L as Rt,M as Nt,N as Ee,O as Pt}from"./playerChat-BxaURsEE.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";let Ce=null;function at(e){if(e==null||isNaN(e))return"--:--:--";const t=Math.floor(e/36e5),n=Math.floor(e%36e5/6e4),a=Math.floor(e%6e4/1e3);return`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}:${String(a).padStart(2,"0")}`}function ot(e){return document.getElementById("timer-display")||document.getElementById("control-timer-display")}function Gt(e,t){const n=ot();if(!n||!e)return;J();const a=()=>{const s=e-Date.now();if(s<=0){n.textContent="00:00:00",J();return}n.textContent=at(s)};a(),Ce=setInterval(a,1e3)}function J(){Ce&&(clearInterval(Ce),Ce=null)}function Dt(){const e=ot();if(!e){console.warn("â±ï¸ Timer display not found â€” skipping listener init.");return}const t=S(d,"game","gameState");O(t,n=>{const a=n.data();if(!a)return;const{status:s,endTime:o,startTime:r,durationMinutes:i,remainingMs:l}=a;let c=null;switch(o!=null&&o.toMillis?c=o.toMillis():r!=null&&r.toMillis&&i?c=r.toMillis()+i*6e4:l&&(c=Date.now()+l),s){case"active":c?Gt(c):(J(),e.textContent="--:--:--");break;case"paused":J(),e.textContent=l?at(l):"--:--:--";break;case"waiting":J(),e.textContent="--:--:--";break;case"finished":case"ended":J(),e.textContent="00:00:00";break;default:J(),e.textContent="--:--:--"}e.id==="control-timer-display"&&(e.hidden=s==="waiting")})}async function He(){try{const e=await k(f(d,"communications")),t=await k(f(d,"scores")),n=Ke(d);e.forEach(a=>n.delete(a.ref)),t.forEach(a=>n.delete(a.ref)),await n.commit(),console.log("ğŸ’¬ğŸ§® Chats and scores cleared.")}catch(e){console.error("âŒ Failed to clear chats/scores:",e)}}async function Ht(){const{collection:e,getDocs:t,deleteDoc:n}=await ce(async()=>{const{collection:i,getDocs:l,deleteDoc:c}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");return{collection:i,getDocs:l,deleteDoc:c}},[]),{db:a}=await ce(async()=>{const{db:i}=await import("./config-DpNrAFUu.js");return{db:i}},__vite__mapDeps([0,1])),{resetGameState:s}=await ce(async()=>{const{resetGameState:i}=await import("./playerChat-BxaURsEE.js").then(l=>l.ad);return{resetGameState:i}},__vite__mapDeps([2,0,1])),{showFlashMessage:o}=await ce(async()=>{const{showFlashMessage:i}=await import("./playerChat-BxaURsEE.js").then(l=>l.ac);return{showFlashMessage:i}},__vite__mapDeps([2,0,1])),r=["communications","conversations","flatTireAssignments","game","racers","scores","settings","speedBumpAssignments","surpriseAudit","teamStatus","teamSurprises","zones"];o("ğŸ§¹ Clearing Firestore collections...");try{for(const i of r){const l=await t(e(a,i)),c=[];l.forEach(u=>c.push(n(u.ref))),c.length>0&&await Promise.allSettled(c),console.log(`âœ… Cleared ${i} (${c.length} docs)`)}await s(),o("âœ… All collections cleared and game reset.")}catch(i){console.error("âŒ clearAllCollectionsAndReset failed:",i),o("âš ï¸ Reset failed â€“ see console for details.")}}const Ot="_controlSection_1t5vd_8",qt="_gameControls_1t5vd_34",Ft="_controlButton_1t5vd_43",Ut="_start_1t5vd_64",jt="_pause_1t5vd_74",Zt="_end_1t5vd_84",Wt="_warning_1t5vd_94",Qt="_timerSetup_1t5vd_105",Yt="_teamSetup_1t5vd_106",Kt="_liveTimer_1t5vd_125",Vt="_liveTimerValue_1t5vd_141",E={controlSection:Ot,gameControls:qt,controlButton:Ft,start:Ut,pause:jt,end:Zt,warning:Wt,timerSetup:Qt,teamSetup:Yt,liveTimer:Kt,liveTimerValue:Vt};function U(e,t="#7b1fa2"){let n=document.getElementById("top3-banner");n||(n=document.createElement("div"),n.id="top3-banner",n.style.cssText=["position: fixed;","top: 25%;","left: 50%;","transform: translateX(-50%);",`background: ${t};`,"color: white;","padding: 25px 40px;","border-radius: 10px;","font-size: 2rem;","font-weight: bold;","text-align: center;","opacity: 0;","z-index: 9999;","transition: opacity 1s ease-in-out;","box-shadow: 0 0 25px rgba(0,0,0,0.5);","white-space: pre-line;"].join(" "),document.body.appendChild(n)),n.style.background=t,n.innerText=e,n.style.opacity="1",setTimeout(()=>n.style.opacity="0",4e3)}function Jt(){const e=["ğŸ‰","âœ¨","ğŸŠ","ğŸ¥³","ğŸ","ğŸ‡","ğŸ†"];for(let n=0;n<30;n++){const a=document.createElement("div");a.textContent=e[Math.floor(Math.random()*e.length)],a.style.cssText=["position: fixed;",`left: ${Math.random()*100}vw;`,"top: -5vh;",`font-size: ${Math.random()*24+16}px;`,"opacity: 0.9;",`transform: rotate(${Math.random()*360}deg);`,"transition: transform 3s ease-in, top 3s ease-in, opacity 3s ease-out;","z-index: 9999;"].join(" "),document.body.appendChild(a),setTimeout(()=>{a.style.top="110vh",a.style.transform=`rotate(${Math.random()*720}deg)`,a.style.opacity="0"},50),setTimeout(()=>a.remove(),3500+Math.random()*500)}}async function Xt(){var o;const e=await k(f(d,"scores")),t=[];if(e.forEach(r=>{const i=r.data();t.push({name:r.id,score:i.score||0})}),t.length===0){U("No teams found â€” no results to announce.","#555");return}t.sort((r,i)=>i.score-r.score);const n=t.slice(0,3),a=((o=n[0])==null?void 0:o.score)||0;let s=`ğŸ FINAL STANDINGS ğŸ
dist/assets/control-Dx2J0vur.js:504: </td></tr>`)}window.dispatchEvent(new CustomEvent("scoreboardCleared")),window.dispatchEvent(new CustomEvent("forceScoreboardRefresh")),_("ğŸ§¹ Scoreboard & locations cleared.","#2e7d32",2e3),console.log(`âœ… Scoreboard cleared (${e?"auto":"manual"})`),console.groupEnd()}catch(n){console.error("âŒ Error clearing scoreboard:",n),_("Scoreboard clearing failed.","#c62828",3e3)}}async function Io(){try{console.group("ğŸ SAFE END GAME"),await he(lt,{status:"finished",updatedAt:C()}),console.log("ğŸ•¹ï¸ Game status updated â†’ finished");const e=await k(f(d,"zones"));for(const n of e.docs)await he(S(d,"zones",n.id),{status:"Available",controllingTeam:"",lastUpdated:C()});console.log(`ğŸ—ºï¸ ${e.size} zones reset`);const t=await k(f(d,"teamStatus"));for(const n of t.docs){const a=S(d,"teamStatus",n.id);await oe(a),await M(a,{lastKnownLocation:"",controllingTeam:"",activeZone:"",timestamp:C()})}console.log(`ğŸ§­ ${t.size} teamStatus docs wiped`),await ct(!0),await zo(),await q(f(d,"communications"),{teamName:"Game Master",message:"ğŸ Game ended â€” zones & scoreboard reset.",isBroadcast:!0,timestamp:C()}),_("ğŸ Game ended & reset complete.","#2e7d32",2500),console.log("âœ… Full reset done."),console.groupEnd()}catch(e){console.error("âŒ Error ending game:",e),_("End/Reset failed.","#c62828",3e3)}}async function Mo(){try{await ct(!0),await M(lt,{status:"waiting",zonesReleased:!1,startTime:null,endTime:null,durationMinutes:null,remainingMs:null,updatedAt:C()},{merge:!0}),_("ğŸ”„ Game reset to WAITING.","#2e7d32",2e3),console.log("ğŸ”„ Game state fully reset to WAITING.")}catch(e){console.error("âŒ Error resetting game:",e),_("Reset failed.","#c62828",2500)}}async function dt(e){const t=Number.isFinite(Number(e))&&Number(e)>=0?Math.floor(Number(e)):0,n=await k(f(d,"teamStatus")),a=n.docs.map(s=>he(s.ref,{wildCards:t}));return await Promise.all(a),_(`ğŸƒ Wild cards set to ${t} for all teams.`,"#512da8",2500),console.log(`ğŸƒ Wild cards set to ${t} for ${n.size} teamStatus docs.`),t}typeof window<"u"&&(window.applyWildCardsToAllTeams=dt);async function zo(){const e=["flatTireAssignments","teamSurprises","shields"];try{for(const t of e){const n=await k(f(d,t)),a=n.docs.map(s=>oe(s.ref));a.length&&await Promise.allSettled(a),console.log(`ğŸ§¹ Cleared ${n.size} docs from ${t}`)}await kt()}catch(t){console.error("âŒ Error clearing transient game data:",t)}}const xo=[{key:X.FLAT_TIRE,label:"Flat Tire"},{key:X.BUG_SPLAT,label:"Bug Splat"},{key:X.WILD_CARD,label:"Super SHIELD Wax"}];let ae=null;function Ro(){return`
dist/assets/control-Dx2J0vur.js:528: `}function No(){Po("reinitialize");const e=document.getElementById("surprise-table-body");if(!e)return console.warn("âš ï¸ Surprise selector table body missing."),()=>{};const t=document.getElementById("wildcard-dashboard-input"),n=document.getElementById("wildcard-dashboard-apply");let a=null;t&&n&&(a=async()=>{const i=Number.parseInt(t.value,10);if(!Number.isFinite(i)||i<0){alert("Please enter a non-negative number.");return}const l=Math.floor(i);n.disabled=!0;try{await dt(l),alert(`âœ… All teams set to ${l} wild card${l===1?"":"s"}.`)}catch(c){console.error("âŒ Failed to apply wild cards to all teams:",c),alert("âŒ Failed to update wild cards. Check console for details.")}finally{n.disabled=!1}},n.addEventListener("click",a));const s=Go();e.addEventListener("click",s);const o=Lt((i=[],l={})=>{const c=Do(i,l);We(e,c)}),r=window.setInterval(()=>{Qe(e)},1e3);return ae=(i="manual")=>{o==null||o(),e.removeEventListener("click",s),clearInterval(r),n&&a&&n.removeEventListener("click",a),ae=null,console.info(`ğŸ§¹ [SurpriseSelector] cleaned up (${i})`)},We(e,new Map),Qe(e),ae}function Po(e="manual"){ae==null||ae(e),ae=null}function Go(){return async e=>{const t=e.target.closest("button[data-action]");if(!t)return;const n=t.dataset.team,a=t.dataset.type,s=t.dataset.action;if(!(!n||!a||!s))try{s==="increment"?await At(n,a):s==="decrement"&&await It(n,a)}catch(o){console.error(`âŒ Failed to ${s} surprise for ${n}/${a}:`,o)}}}function Do(e,t){const n=new Map;return t&&typeof t=="object"?Object.entries(t).forEach(([a,s])=>{n.set(a,s||{})}):Array.isArray(e)&&e.forEach(a=>{n.set(a.teamName,a.counts||{})}),n}function We(e,t){const n=document.createDocumentFragment();de.forEach(a=>{const s=document.createElement("tr");s.dataset.team=a.name;const o=t.get(a.name)||{};Se(o[X.FLAT_TIRE]??o.flatTire),Se(o[X.BUG_SPLAT]??o.bugSplat);const i=Se(o[X.WILD_CARD]??o.superShieldWax??o.wildCard)>0;s.className=i?I.hasStock:I.noStock,s.innerHTML=`
dist/assets/control-Dx2J0vur.js:665: `.repeat(10)+"ğŸ§¹ ALL CHAT, SCORES, TEAM STATUSES & ZONES CLEARED ğŸ§¹"),_("ğŸ§¼ All data fully cleared.","#1565c0",3e3),console.log("âœ… All data cleared: chat, scores, teamStatus, zones.")}catch(e){console.error("âŒ Error during full Clear All:",e),_("âŒ Clear All failed.","#c62828",4e3)}}async function Ss(){try{const e=f(d,"teamStatus"),n=(await k(e)).docs.map(a=>he(a.ref,{lastKnownLocation:"",timestamp:C()}));await Promise.allSettled(n),console.log("ğŸ§¼ All teamStatus entries cleared!")}catch(e){console.error("âŒ Error clearing teamStatus collection:",e)}}async function $s(){try{const e=f(d,"zones"),n=(await k(e)).docs.map(a=>M(a.ref,{status:"Available",controllingTeam:null,updatedAt:C()},{merge:!0}));await Promise.allSettled(n),console.log("ğŸ—ºï¸ All zones reset to Available.")}catch(e){console.error("âŒ Error clearing zones collection:",e)}}async function ut(e){try{const{addDoc:t,serverTimestamp:n}=await ce(async()=>{const{addDoc:a,serverTimestamp:s}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");return{addDoc:a,serverTimestamp:s}},[]);await t(f(d,"communications"),{teamName:"Game Master",sender:"Game Master",senderDisplay:"Game Master",message:e,isBroadcast:!0,timestamp:n()})}catch(t){console.error("âš ï¸ Failed to broadcast system notice:",t)}}function Es(e){try{if(!e)return"";if(typeof e.toDate=="function")return e.toDate().toLocaleTimeString();if(typeof e.toMillis=="function")return new Date(e.toMillis()).toLocaleTimeString();if(typeof e.seconds=="number")return new Date(e.seconds*1e3).toLocaleTimeString();if(typeof e=="number")return new Date(e).toLocaleTimeString()}catch(t){console.warn("âš ï¸ Bad timestamp:",t)}return""}const Ie=S(d,"game","gameState"),Ts=30;function Bs(){const e=document.getElementById("start-btn"),t=document.getElementById("pause-btn"),n=document.getElementById("release-zones-btn"),a=document.getElementById("end-btn"),s=document.getElementById("reset-game-btn"),o=document.getElementById("clear-scores-btn");e&&e.addEventListener("click",async()=>{try{await xe();const r=await ee(Ie),i=r.exists()?r.data():{},l={status:"active",zonesReleased:!0,updatedAt:C()};i.startTime||(l.startTime=C()),i.durationMinutes||(l.durationMinutes=Ts),await he(Ie,l),await q(f(d,"communications"),{teamName:"Game Master",sender:"Game Master",senderDisplay:"Game Master",message:"ğŸ A new game has begun! Scoreboard cleared, chat wiped, and zones live.",isBroadcast:!0,timestamp:C()}),Rt({parent:document.body}),_("âœ… Game Started! Everything cleared and ready.","#2e7d32",3e3)}catch(r){console.error("Error starting game:",r),_("Start failed.","#c62828",2500)}}),t&&t.addEventListener("click",async()=>{try{const r=await ee(Ie);(r.exists()?r.data():{}).status==="paused"?(await Ve(),t.textContent="Pause Game",_("â–¶ï¸ Game Resumed!","#2e7d32",2500)):(await Je(),t.textContent="Resume Game",_("â¸ï¸ Game Paused!","#ff9800",2500))}catch(r){console.error("Pause/Resume error:",r),_("Pause/Resume failed.","#c62828",2500)}}),n&&n.addEventListener("click",async()=>{try{await Nt(),_("Zones Released!","#1976d2",3e3)}catch(r){console.error("Error releasing zones:",r),_("Zone release failed.","#c62828",2500)}}),a&&a.addEventListener("click",async()=>{try{await Io(),_("ğŸ Game Ended! Zones reset.","#c62828",4e3),t.textContent="Pause Game"}catch(r){console.error("Error ending game:",r),_("End failed.","#c62828",2500)}}),s&&s.addEventListener("click",async()=>{confirm("Reset game state to WAITING and clear all scoreboard data (scores + locations)?")&&(await Mo(),t.textContent="Pause Game",_("ğŸ”„ Game fully reset.","#757575",3e3))}),o&&o.addEventListener("click",async()=>{if(confirm("âš ï¸ This will clear ALL chat, scores, zones, and team statuses. Continue?"))try{await xe(),_("ğŸ§¹ All chat, scores, and team statuses cleared.","#1565c0",4e3)}catch(r){console.error("Error clearing data:",r),_("âŒ Clear failed.","#c62828",2500)}})}const ks=S(d,"game","gameState"),ge=[];function P(e,t="anonymous"){typeof e=="function"&&(ge.push({fn:e,label:t}),console.info(`ğŸ—‚ï¸ [control] registered cleanup â†’ ${t}`))}function mt(e="manual"){if(ge.length)for(console.info(`ğŸ§¹ [control] running ${ge.length} cleanup handler(s) (${e})`);ge.length;){const{fn:t,label:n}=ge.pop();try{t(e),console.info(`ğŸ§¼ [control] cleanup completed for ${n}`)}catch(a){console.warn(`âš ï¸ [control] cleanup failed for ${n}:`,a)}}}async function Ls(){mt("reinitialize"),Is(),P(co()||null,"scoreboard"),P(tn()||null,"gameControls"),P(Pa()||null,"racerManagement"),P(ho()||null,"broadcast"),P(ln()||null,"bugStrikeControl");const e=await Kn();P(e,"speedBumpControl");const t=await za();P(t,"flatTireControl"),P(No()||null,"surpriseSelector");const n=await ys();P(n,"communications");try{await vs();const a=await ao(!0);P(a,"zoneManagement")}catch(a){console.error("âŒ Google Maps API load failed:",a),_("Map failed to load. Check API key.","#c62828",3e3)}try{const a=await fs();P(a,"zoneQuestions"),console.log("âœ… Zone Questions initialized.")}catch(a){console.error("âš ï¸ Zone Questions init failed:",a),_("âš ï¸ Failed to load Zone Questions.","#ff9800",3e3)}Bs(),P(ws(),"liveGameStatus"),P(nt(a=>As(a)),"controlTimer")}function As(e){var l,c,u;const{status:t,startTime:n,endTime:a,durationMinutes:s,remainingMs:o}=e||{},r=document.getElementById("control-timer-display");if(!r)return;switch(t||"waiting"){case"waiting":r.hidden=!0,r.textContent="00:00:00",(l=Ee)==null||l();break;case"active":{r.hidden=!1;let p=null;a!=null&&a.toMillis?p=a.toMillis():n!=null&&n.toMillis&&s?p=n.toMillis()+s*60*1e3:o&&(p=Date.now()+o),p&&Pt(p);break}case"paused":(c=Ee)==null||c(),r.hidden=!1,r.textContent="â¸ï¸ PAUSED";break;case"finished":case"ended":(u=Ee)==null||u(),r.hidden=!1,r.textContent="00:00";break;default:r.hidden=!1,r.textContent="00:00:00"}}function Is(){H("game-controls-container",en()),H("scoreboard-container",lo()),H("bugstrike-control-container",rn()),H("flat-tire-control-container",Ma()),H("speedbump-control-container",Yn()),H("surprise-selector-container",Ro()),H("team-links-container",yo()),H("racer-management-container",Na()),H("zone-management-container",Za()),H("broadcast-container",go()),H("zone-questions-container",hs())}function H(e,t){const n=document.getElementById(e);n?n.innerHTML=t:console.warn(`âš ï¸ Missing container: ${e}`)}document.addEventListener("DOMContentLoaded",async()=>{try{console.log("ğŸ§­ Checking current game state before initialization...");const e=await ee(ks);((e.exists()?e.data():{}).status||"waiting")==="active"?(console.log("âš ï¸ Active game detected. Skipping cleanup."),_("âš ï¸ Active game detected â€” skipping auto-clean to preserve data.","#ff9800",4e3)):(console.log("ğŸ§¹ Performing initial cleanup before control panel loads..."),await xe(),_("ğŸ§¼ Control panel cleaned. Fresh start ready!","#2196f3",3e3))}catch(e){console.error("âš ï¸ Initial cleanup check failed:",e),_("âš ï¸ Cleanup check failed. Proceeding without wipe.","#c62828",3e3)}Ls()});window.addEventListener("beforeunload",()=>mt("page-unload"),{once:!0});
dist/assets/player-C3Rg7B0w.js:39: </td>`,r.appendChild(m);const u=M(p,"teamStatus",a.name);U(u,async d=>{const c=I(`opp-loc-${l}`);if(!c)return;if(!d.exists()){c.textContent="--";return}const f=d.data(),y=typeof f.lastKnownLocation=="string"?f.lastKnownLocation.trim():"",C=xt(f.timestamp);let L="--";if(y)try{L=await _e(y)}catch(g){console.warn("âš ï¸ Zone label fallback for",y,g),L=y}c.textContent=L!=="--"?`ğŸ“ ${L}${C?` (updated ${C})`:""}`:"--",c.style.background="#f0c420",c.style.color="#000",setTimeout(()=>{c.style.background="",c.style.color=""},800)})}),r.addEventListener("click",a=>{var m;const l=a.target;if(l.classList.contains("send-btn")){const u=l.dataset.team,d=u.replace(/\s+/g,"-"),c=I(`msg-input-${d}`),f=(m=c==null?void 0:c.value)==null?void 0:m.trim();if(!f)return;console.log(`ğŸ“¨ [Message to ${u}] ${f}`),c.value="";try{typeof window.sendTeamMessage=="function"?window.sendTeamMessage(u,f):window.chatManager&&typeof window.chatManager.sendTeamMessage=="function"?window.chatManager.sendTeamMessage(u,f):console.warn("âš ï¸ No sendTeamMessage() available â€” message not sent.")}catch(y){console.error("ğŸ’¥ Error sending message:",y)}}}))}typeof document<"u"&&document.addEventListener("DOMContentLoaded",()=>{const e=Ce();e&&Le(e)});let F=!0,P=null;const R=new Set;function ue(e,t){typeof t=="function"&&(R.add({label:e,unsub:t}),console.info(`ğŸ“¡ [zones] attached listener â†’ ${e}`))}function fe(e="manual"){var t;if(R.size){console.info(`ğŸ§¹ [zones] detaching ${R.size} listener(s) (${e})`);for(const o of R)try{(t=o.unsub)==null||t.call(o)}catch(s){console.warn(`âš ï¸ [zones] failed to detach listener ${o.label}:`,s)}R.clear()}}async function $t(e){fe("reinitialize");const t=q.find(n=>n.name===e);P=t?t.name:e,vt(P);const o=await Ze("player-zones-tbody"),s=G(p,"zones");return ue("gameState",U(M(p,"game","gameState"),n=>{const r=n.data();if(!(r!=null&&r.status))return;const i=F,a=!(r.status==="active"&&r.zonesReleased);i&&!a&&(je(),console.log("ğŸ Race started â€” zones unlocked for challenges!")),["finished","ended"].includes(r.status)&&Et(),F=a})),ue("zonesCollection",U(s,n=>{o.innerHTML="",n.forEach(r=>{const i=r.data(),a=r.id,l=i.status==="Taken"&&i.controllingTeam?`Controlled by ${i.controllingTeam}`:"Available",m=F?"disabled":"",u=document.createElement("tr");u.dataset.zoneId=a,u.innerHTML=`
dist/assets/player-C3Rg7B0w.js:100: `,t}function Pt(e){if(!e)return;const t=document.createElement("div");t.className="bugstrike-splat",t.textContent="ğŸ’¥ SPLAT!",t.style.position="absolute",t.style.left=Math.random()*90+"vw",t.style.top=Math.random()*80+"vh",t.style.fontSize=Math.random()*20+20+"px",t.style.color=Rt(),t.style.opacity="0",t.style.transition="opacity 0.3s, transform 0.3s",t.style.transform="scale(0.5) rotate("+(Math.random()*60-30)+"deg)",t.style.cursor="pointer",e.appendChild(t),setTimeout(()=>{t.style.opacity="1",t.style.transform="scale(1) rotate("+(Math.random()*60-30)+"deg)"},10),t.addEventListener("click",()=>{const o=new Audio("/sounds/splat.mp3");o.volume=.4,o.play().catch(()=>{}),t.textContent=`ğŸ’¦ SPLAT! (${Pe(S)})`,S=Math.max(0,S-1),t.style.opacity="0",setTimeout(()=>t.remove(),300)}),setTimeout(()=>t.remove(),2500)}function Ft(e){const t=e.querySelector("#bugstrike-countdown");t&&(t.textContent=`Time Remaining: ${Pe(S)}`)}function It(e){e&&(e.style.transition="opacity 1s ease-out",e.style.opacity="0",setTimeout(()=>{e.remove(),ee=!1,ke(!1)},1e3))}function ke(e){document.querySelectorAll("button, input, select, textarea").forEach(o=>{e?(o.disabled=!0,o.style.filter="grayscale(0.8)",o.style.cursor="not-allowed"):(o.disabled=!1,o.style.filter="",o.style.cursor="")})}function Pe(e){const t=Math.floor(e/60),o=String(e%60).padStart(2,"0");return`${t}:${o}`}function Rt(){const e=["#ff5252","#ffeb3b","#00e676","#03a9f4","#ff80ab"];return e[Math.floor(Math.random()*e.length)]}function At(e=""){if(typeof e!="string")return null;const[t,o]=e.split(","),s=Number.parseFloat(t),n=Number.parseFloat(o);return!Number.isFinite(s)||!Number.isFinite(n)?null:{lat:s,lng:n}}function Nt(e){if(!e)return()=>{};let t=null;return t=Ve((s=[])=>{const n=s.find(g=>(g==null?void 0:g.teamName)===e);if(Qe(e)||Je(e)){n&&Z();return}if(!n){Z();return}const{zoneName:r,gps:i,status:a,distanceRemainingKm:l,autoReleaseAtMs:m,assignedAtMs:u}=n,d=Number.isFinite(n.lat)&&Number.isFinite(n.lng)?{lat:Number(n.lat),lng:Number(n.lng)}:null,c=At(i);(d==null?void 0:d.lat)??(c==null||c.lat),(d==null?void 0:d.lng)??(c==null||c.lng);const f=Number.isFinite(n.diameterMeters)&&n.diameterMeters>0?n.diameterMeters:Number.isFinite(n.diameter)&&n.diameter>0?n.diameter*1e3:200,y=typeof n.assignedBy=="string"&&n.assignedBy.trim()?n.assignedBy.trim():typeof n.fromTeam=="string"&&n.fromTeam.trim()?n.fromTeam.trim():"Game Control";n.depotId||n.zoneKey;const C=async()=>{if(!i){alert("Tow zone GPS is missing. Contact Control.");return}if(!("geolocation"in navigator)){alert("Geolocation is not supported in this browser.");return}try{const g=await new Promise((Y,oe)=>{const ae=setTimeout(()=>{oe(new Error("GPS location request timed out. Please ensure you have granted permission and have a clear view of the sky."))},15e3);navigator.geolocation.getCurrentPosition(V=>{clearTimeout(ae),Y(V)},V=>{clearTimeout(ae),oe(V)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:5e3})}),k={lat:g.coords.latitude,lng:g.coords.longitude},W=tt(i,k);if(!Number.isFinite(W))throw new Error("Unable to calculate distance to tow zone.");const Be=W/1e3;if(!nt(i,k)){alert(`You're ${Math.round(W)}m away. Move within ${ot}m before checking in.`),await se(e,{status:"enroute",distanceRemainingKm:Be});return}await se(e,{status:"arrived",distanceRemainingKm:0,arrivalLat:k.lat,arrivalLng:k.lng,arrivedAt:Date.now()}),bt(),yt();try{await at("Game Master",`ğŸ› ${e} repaired their Flat Tire and is back in the race!`,!0)}catch(Y){console.warn("âš ï¸ Flat Tire celebration broadcast failed:",Y)}await L(),alert("âœ… Tow crew confirmed! You are inside the capture radius.");return}catch(g){console.error("âŒ Failed to submit Flat Tire check-in:",g);const k=(g==null?void 0:g.message)||"Unable to capture your location. Please enable GPS and try again.";alert(k)}},L=async()=>{try{await it(e)}catch(g){console.error("âŒ Failed to release Flat Tire assignment:",g),alert("Unable to release your Flat Tire assignment right now.")}};wt({zoneName:r,gps:i,diameterMeters:f,autoReleaseAtMs:m,onCheckIn:C,onChirp:()=>Xe(e,y,et("flatTire"))})}),(s="manual")=>{t==null||t(),t=null,Z(),console.info(`ğŸ§¹ [flatTireUI] cleaned up (${s})`)}}let b=null,v=null,A=null,N=null,B=null,z=null,$=null;function he(e="manual"){v==null||v(e),v=null,A==null||A(e),A=null,N==null||N(e),N=null,B==null||B(e),B=null,z==null||z(e),z=null,b==null||b(e),b=null,$&&(window.removeEventListener("beforeunload",$),$=null)}async function Bt(){var s,n;he("reinitialize"),console.log("ğŸš€ Initializing player page...");const e=new URLSearchParams(window.location.search),t=((s=e.get("teamName"))==null?void 0:s.trim())||((n=e.get("team"))==null?void 0:n.trim())||localStorage.getItem("teamName")||null;if(!t){alert("No team assigned. Please use your official team link."),console.error("âŒ Missing team name.");return}localStorage.setItem("teamName",t),typeof window<"u"&&(window.currentPlayerTeam=t);const o=q.find(r=>r.name===t);if(!o){alert(`Team "${t}" not found in data.js`),console.error("âŒ Invalid team:",t);return}try{Le(o,t),v==null||v(),v=rt(t),A=$t(t),st(),B=St(t),N=lt(t),z=Nt(t)}catch(r){console.error("ğŸ”¥ Error initializing player modules:",r),alert("Error initializing player. Check console.");return}Ie(),E("--:--:--");try{const r=await j(M(p,"game","gameState")),i=r.exists()?r.data():null;if((i==null?void 0:i.status)==="active"){Re();const a=Fe(i);a&&(Ae(a),D("ğŸ Game in Progress!","#2e7d32",1200))}}catch(r){console.error("âš ï¸ Could not fetch initial game state:",r)}b==null||b(),b=ct(r=>zt(r)),$&&window.removeEventListener("beforeunload",$),$=()=>he("page-unload"),window.addEventListener("beforeunload",$,{once:!0}),console.log("âœ… Player initialized for team:",t)}function Fe(e){if(!e)return null;const t=e.endTime;if(t){if(typeof t.toMillis=="function")return t.toMillis();if(t.seconds)return t.seconds*1e3+Math.floor((t.nanoseconds||0)/1e6);if(typeof t=="number")return t}const o=e.startTime;if(o&&e.durationMinutes){if(typeof o.toMillis=="function")return o.toMillis()+e.durationMinutes*60*1e3;if(o.seconds)return o.seconds*1e3+e.durationMinutes*60*1e3}return typeof e.remainingMs=="number"?Date.now()+e.remainingMs:null}let H=null,J=null;function zt(e){const{status:t,endTime:o,startTime:s,durationMinutes:n,remainingMs:r}=e||{};switch(t){case"waiting":Ie(),Q(),te(),E("--:--:--");break;case"active":{Re(),Q();const i=Fe({endTime:o,startTime:s,durationMinutes:n,remainingMs:r});i?(Ae(i),D("ğŸ Game in Progress!","#2e7d32",1200)):E("--:--:--");break}case"paused":J=Ot(),pt(),D("â¸ï¸ Game Paused by Control","#ff9800",1600),typeof J=="number"&&E(Ne(J));break;case"finished":case"ended":te(),E("00:00:00"),Q(),Se(),D("ğŸ Game Over! Return to base.","#c62828",3e3);break}}function Ie(){if(document.getElementById("waiting-banner"))return;const e=document.createElement("div");e.id="waiting-banner",e.textContent="â³ Waiting for the game to start...",Object.assign(e.style,{position:"fixed",top:"0",left:"0",width:"100%",background:"#333",color:"white",textAlign:"center",padding:"12px",fontWeight:"bold",zIndex:"2000"}),document.body.appendChild(e)}function Re(){var e;(e=document.getElementById("waiting-banner"))==null||e.remove()}function E(e){const t=document.getElementById("timer-display");t&&(t.textContent=e)}function Ae(e){clearInterval(H),window._currentEndTime=e,we(e),H=setInterval(()=>we(e),1e3)}function te(){clearInterval(H),H=null}function Ot(){if(!window._currentEndTime)return null;const e=window._currentEndTime-Date.now();return te(),e>0?e:0}function Ne(e){const t=Math.max(0,Math.floor(e/1e3)),o=Math.floor(t/3600),s=Math.floor(t%3600/60),n=t%60;return`${String(o).padStart(2,"0")}:${String(s).padStart(2,"0")}:${String(n).padStart(2,"0")}`}function we(e){const t=e-Date.now();if(t<=0){clearInterval(H),E("00:00:00"),Se();return}E(Ne(t))}document.addEventListener("DOMContentLoaded",Bt);
dist/assets/playerChat-BxaURsEE.js:2: import{db as p}from"./config-DpNrAFUu.js";import{doc as D,onSnapshot as B,getDoc as pe,Timestamp as He,updateDoc as nt,serverTimestamp as C,collection as A,runTransaction as xe,getDocs as Ae,deleteDoc as It,addDoc as Re,setDoc as ge,query as J,orderBy as je,collectionGroup as jt,where as qe,writeBatch as qt}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";const fe=[{name:"Team Kumquat",slogan:"We like it hot and ready",email:"team.kumquat@routeriot.game"},{name:"Team Wiener",slogan:"Too hard to handle",email:"team.wiener@routeriot.game"},{name:"Team Quiff",slogan:"We will make you smell Defeat",email:"team.quiff@routeriot.game"},{name:"Team Angry Beaver",slogan:"Fury. Foaming. Not to be messed with.",email:"team.angry.beaver@routeriot.game"},{name:"Team Moist Muffin",slogan:"Looking soft and smooth but playing hard!",email:"team.moist.muffin@routeriot.game"},{name:"Team Grumpy Pickles",slogan:"Sour but strong",email:"team.grumpy.pickles@routeriot.game"},{name:"Team Hairy Peach",slogan:"Soft, fuzzy, and full of surprises",email:"team.hairy.peach@routeriot.game"},{name:"Team Squirt Gun",slogan:"Locked, loaded, and ready to blast",email:"team.squirt.gun@routeriot.game"},{name:"Team Hump Day",slogan:"One ride, endless memories",email:"team.hump.day@routeriot.game"},{name:"Team Moose Knuckle",slogan:"The bigger the knuckle, the bigger your problem.",email:"team.moose.knuckle@routeriot.game"},{name:"Team Buttered Buns",slogan:"Warm, soft, and ready for action",email:"team.buttered.buns@routeriot.game"},{name:"Team Spicy Taco",slogan:"Explosive flavour, explosive victory",email:"team.spicy.taco@routeriot.game"}],Kt="modulepreload",Yt=function(e){return"/"+e},ut={},dt=function(t,s,n){let o=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),i=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));o=Promise.allSettled(s.map(l=>{if(l=Yt(l),l in ut)return;ut[l]=!0;const d=l.endsWith(".css"),h=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const m=document.createElement("link");if(m.rel=d?"stylesheet":Kt,d||(m.as="script"),m.crossOrigin="",m.href=l,i&&m.setAttribute("nonce",i),document.head.appendChild(m),d)return new Promise((S,x)=>{m.addEventListener("load",S),m.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(r){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=r,window.dispatchEvent(i),!i.defaultPrevented)throw r}return o.then(r=>{for(const i of r||[])i.status==="rejected"&&a(i.reason);return t().catch(a)})};let le=null;const Dt=e=>document.getElementById(e);function Se(e){const t=Dt("player-timer");if(!t||!e)return;T();const s=e!=null&&e.seconds?new Date(e.seconds*1e3):e instanceof Date?e:new Date(e);le=setInterval(()=>{const n=s.getTime()-Date.now();if(n<=0){t.textContent="00:00:00",clearInterval(le);return}const o=String(Math.floor(n/36e5%24)).padStart(2,"0"),a=String(Math.floor(n/6e4%60)).padStart(2,"0"),r=String(Math.floor(n/1e3%60)).padStart(2,"0");t.textContent=`${o}:${a}:${r}`},1e3)}function T(){le&&clearInterval(le),le=null;const e=Dt("player-timer");e&&(e.textContent="--:--:--")}function _(e,t="#03dac6",s=3e3){const n=document.getElementById("flash-message");n&&n.remove();const o=document.createElement("div");o.id="flash-message",o.textContent=e,Object.assign(o.style,{position:"fixed",top:"0",left:"0",width:"100%",background:t,color:"#000",textAlign:"center",padding:"16px",fontSize:"1.2em",fontWeight:"bold",letterSpacing:"0.5px",zIndex:"5000",transform:"translateY(-100%)",transition:"transform 0.4s ease-in-out",boxShadow:`0 0 12px ${t}`,textShadow:"0 0 6px rgba(0,0,0,0.3)"}),document.body.appendChild(o),setTimeout(()=>o.style.transform="translateY(0)",100),setTimeout(()=>{o.style.transform="translateY(-100%)",setTimeout(()=>o.remove(),500)},s)}function Me({parent:e=document.body,seconds:t=3}={}){const s=document.getElementById("countdown-banner");s&&s.remove();const n=document.createElement("div");n.id="countdown-banner",Object.assign(n.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(0,0,0,0.92)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"9999",fontSize:"18vw",color:"#00ff90",fontWeight:"bold",textShadow:"0 0 30px #00ff90",letterSpacing:"4px",fontFamily:"monospace",transition:"opacity 0.5s ease"}),e.appendChild(n);let o=t;const a=()=>{o>0?(n.textContent=o,n.style.transform="scale(1.4)",n.style.opacity="0",setTimeout(()=>{n.style.transition="transform 0.4s, opacity 0.4s",n.style.transform="scale(1)",n.style.opacity="1"},50),o--):(n.textContent="GO!",n.style.color="#03dac6",n.style.textShadow="0 0 40px #03dac6",setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),500)},900),clearInterval(r))},r=setInterval(a,1e3);a()}const ls=Object.freeze(Object.defineProperty({__proto__:null,clearElapsedTimer:T,showCountdownBanner:Me,showFlashMessage:_,startCountdownTimer:Se},Symbol.toStringTag,{value:"Module"})),oe=D(p,"game","gameState");let Fe=!1;const ft=new Set;async function Zt(){var e,t;try{const s=await pe(oe);if(!s.exists())throw new Error("Game state not found");const n=s.data();let o=null;(e=n.endTime)!=null&&e.toMillis?o=n.endTime.toMillis():(t=n.endTime)!=null&&t.getTime&&(o=n.endTime.getTime());const a=o?Math.max(o-Date.now(),0):n.remainingMs??0;await nt(oe,{status:"paused",remainingMs:a,endTime:null,updatedAt:C()}),console.log(`â¸ï¸ Game paused (${Math.floor(a/1e3)}s remaining)`)}catch(s){console.error("âŒ Error pausing game:",s)}}async function Qt(){try{const e=await pe(oe);if(!e.exists())throw new Error("Game state not found");const s=e.data().remainingMs??0,n=He.fromMillis(Date.now()+s);await nt(oe,{status:"active",endTime:n,remainingMs:null,updatedAt:C()}),console.log(`â–¶ï¸ Game resumed (ends at ${n.toDate().toLocaleTimeString()})`)}catch(e){console.error("âŒ Error resuming game:",e)}}async function Vt(){try{await nt(oe,{zonesReleased:!0,updatedAt:C()}),console.log("âœ… Zones released!")}catch(e){console.error("âŒ Error releasing zones:",e)}}function mt({status:e="waiting",zonesReleased:t=!1,startTime:s=null,endTime:n=null,durationMinutes:o=null,remainingMs:a=null}){const r=document.getElementById("game-status");switch(r&&(r.textContent=e.toUpperCase()),window.zonesEnabled=e==="active"&&t,e){case"waiting":T==null||T(),_==null||_("Waiting for host...","#616161"),Fe=!1;break;case"active":{Fe||(Fe=!0,Me==null||Me({parent:document.body}),_==null||_("ğŸ The Race is ON!","#2e7d32"));let i=null;n!=null&&n.toMillis?i=n.toMillis():s!=null&&s.toMillis&&o?i=s.toMillis()+o*6e4:a&&(i=Date.now()+a),i?Se==null||Se(i):(T==null||T(),console.warn("âš ï¸ No valid end time for countdown."));break}case"paused":T==null||T(),_==null||_("â¸ï¸ Game paused by host.","#ff9800",2500);break;case"finished":case"ended":T==null||T(),_==null||_("ğŸ Game Over! Return to base.","#c62828",4e3);break;default:console.warn(`âš ï¸ Unknown status "${e}"`),T==null||T()}}function Xt(e){const t=B(oe,s=>{if(!s.exists()){const a={status:"waiting",zonesReleased:!1,startTime:null,endTime:null,durationMinutes:null,remainingMs:null};mt(a),e==null||e(a);return}const n=s.data(),o={status:n.status||"waiting",zonesReleased:!!n.zonesReleased,startTime:n.startTime||null,endTime:n.endTime||null,durationMinutes:n.durationMinutes||null,remainingMs:n.remainingMs||null};mt(o),e==null||e(o)});return ft.add(t),console.info("ğŸ“¡ [gameState] attached status listener"),(s="manual")=>{if(ft.delete(t))try{t(),console.info(`ğŸ§¹ [gameState] detached status listener (${s})`)}catch(n){console.warn("âš ï¸ [gameState] failed to detach listener:",n)}}}async function Jt(){const{doc:e,setDoc:t}=await dt(async()=>{const{doc:a,setDoc:r}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");return{doc:a,setDoc:r}},[]),{db:s}=await dt(async()=>{const{db:a}=await import("./config-DpNrAFUu.js");return{db:a}},__vite__mapDeps([0,1])),n=e(s,"game","gameState"),o={status:"idle",startTime:null,endTime:null,paused:!1,countdownShown:!1,createdAt:new Date().toISOString()};try{await t(n,o,{merge:!0}),console.log("ğŸ•¹ï¸ Game state reset to default.")}catch(a){console.error("âŒ Error resetting game state:",a)}}const us=Object.freeze(Object.defineProperty({__proto__:null,listenForGameStatus:Xt,pauseGame:Zt,releaseZones:Vt,resetGameState:Jt,resumeGame:Qt},Symbol.toStringTag,{value:"Module"})),u=Object.freeze({FLAT_TIRE:"flatTire",BUG_SPLAT:"bugSplat",WILD_CARD:"wildCard"}),en="shieldDuration",pt=15;function tn(){if(typeof window>"u"||!(window!=null&&window.localStorage))return pt;const e=Number.parseInt(window.localStorage.getItem(en),10);return!Number.isFinite(e)||e<=0?pt:Math.min(60,Math.max(1,e))}function Ct(){return tn()*60*1e3}const q=Object.create(null);function Ke(e,t){if(!e)return null;const s=Ct(),n=Number(t),o=Number.isFinite(n)?n:Date.now()+s;return q[e]=o,console.log(`ğŸ›¡ï¸ Shield active for ${e} until ${new Date(o).toLocaleTimeString()}`),o}function ae(e){if(!e)return!1;const t=q[e];return t?t<=Date.now()?(delete q[e],!1):!0:!1}function nn(e){e&&delete q[e]}const xt=A(p,"teamSurprises");function _e(e){return D(xt,e.replace(/[\\/#?]/g,"_"))}function sn(e){if(console.log("ğŸ§© Subscribed to team surprises for UI syncâ€¦"),typeof window<"u"&&(window!=null&&window.fakeTeamData)&&typeof e=="function")try{e([],window.fakeTeamData)}catch(t){console.warn("âš ï¸ team surprise callback (prefill) failed:",t)}return B(xt,t=>{const s=t.docs.map(o=>({id:o.id,teamName:o.id,counts:o.data().counts||{}})),n=Object.create(null);s.forEach(o=>{n[o.teamName]=o.counts||{}}),e==null||e(s,n)})}async function on(e,t){!e||!t||await xe(p,async s=>{const n=_e(e),o=await s.get(n),r={...(o.exists()?o.data():{counts:{}}).counts};r[t]=Math.max(0,(r[t]||0)+1),s.set(n,{counts:r},{merge:!0})})}async function Rt(e,t){!e||!t||await xe(p,async s=>{const n=_e(e),o=await s.get(n);if(!o.exists())return;const r={...(o.data()||{}).counts||{}};r[t]=Math.max(0,(r[t]||0)-1),s.set(n,{counts:r},{merge:!0})})}const ds=on,fs=Rt;function Ye(e){if(!e)return 0;const t=q[e];return t?t<=Date.now()?(delete q[e],0):t-Date.now():0}function an(e,t){if(!e||typeof t!="function")return()=>{};const s=_e(e);return B(s,n=>{const a=(n.exists()?n.data()||{}:{}).counts||{},r=ve(a[u.FLAT_TIRE]??a.flatTire),i=ve(a[u.BUG_SPLAT]??a.bugSplat),l=ve(a[u.WILD_CARD]??a.superShieldWax??a.wildCard);t({team:e,flatTire:r,bugSplat:i,superShieldWax:l})})}async function rn(e,t,s=1){if(!e||!t||s<=0)return!1;const n=cn(t);if(!n)return!1;console.log(`ğŸ¯ ${e} used ${n}`);let o=!1;return await xe(p,async a=>{const r=_e(e),i=await a.get(r),d={...(i.exists()?i.data()||{}:{}).counts||{}},h=ve(d[n]);h<s||(d[n]=Math.max(0,h-s),a.set(r,{counts:d,updatedAt:C()},{merge:!0}),o=!0)}),o}function ve(e){const t=Number(e);return Number.isFinite(t)&&t>=0?t:0}function cn(e){return e?e===u.FLAT_TIRE||e==="flatTire"?u.FLAT_TIRE:e===u.BUG_SPLAT||e==="bugSplat"?u.BUG_SPLAT:e===u.WILD_CARD||e==="wildCard"||e==="superShieldWax"?u.WILD_CARD:null:null}const re=Object.create(null),me=Object.create(null);async function ms(){for(const e of Object.keys(q))delete q[e];for(const e of Object.keys(re))delete re[e];for(const e of Object.keys(me))delete me[e];try{const t=(await Ae(A(p,"teamSurprises"))).docs.map(s=>It(s.ref));t.length&&await Promise.allSettled(t)}catch(e){console.warn("âš ï¸ Failed to clear teamSurprises collection:",e)}}function gt(e){if(!e)return!1;const t=re[e];return t?t.expires<=Date.now()?(delete re[e],!1):!0:!1}function _t(e,t,s){if(!e)return;const n=Date.now()+Math.max(0,Number(s)||0);re[e]={type:t,expires:n}}function Bt(e){e&&delete re[e]}function ht(e,t=6e4){e&&(me[e]=Date.now()+Math.max(0,Number(t)||0))}function ln(e){if(!e)return!1;const t=me[e];return t?t<=Date.now()?(delete me[e],!1):!0:!1}const un=ln;function k(e=""){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const yt=new Map(Array.isArray(fe)?fe.map(e=>[String((e==null?void 0:e.name)||"").trim(),e]):[]),Q=new Map,se=new Map,Ze=new Set,wt=new Set,ue=new Map,Qe=6e4,dn=5*6e4,Ft=9e4,fn=1e4;function L(e){return String(e||"").replace(/[\r\n]+/g," ").replace(/[<>]/g,"").trim()}function mn(e){if(!e)return null;const t=e.trim(),s=yt.get(t);if(s)return s;const n=t.toLowerCase();for(const o of yt.values())if(o!=null&&o.name&&o.name.toLowerCase()===n)return o;return null}function ps(e,t=4e3){return new Promise((s,n)=>{const o=document.getElementById(e);if(o)return s(o);const a=new MutationObserver(()=>{const r=document.getElementById(e);r&&(a.disconnect(),s(r))});a.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{a.disconnect(),n(new Error(`Timeout waiting for element #${e}`))},t)})}function pn(e){const t=document.getElementById("player-location");t&&(t.textContent=e,t.classList.add("flash"),setTimeout(()=>t.classList.remove("flash"),1e3))}function bt(e,t="#222"){let s=document.getElementById("game-banner");s||(s=document.createElement("div"),s.id="game-banner",Object.assign(s.style,{position:"fixed",top:"30%",left:"50%",transform:"translateX(-50%)",background:t,color:"white",padding:"30px 50px",borderRadius:"12px",fontSize:"3em",fontWeight:"bold",textAlign:"center",zIndex:"9999",boxShadow:"0 0 20px rgba(0,0,0,0.5)",transition:"opacity 0.4s ease"}),document.body.appendChild(s)),s.style.background=t,s.textContent=e,s.style.display="block",s.style.opacity="1",setTimeout(()=>{s.style.opacity="0",setTimeout(()=>s.style.display="none",400)},2e3)}async function gs(){const e=["3","2","1","GO!"];for(const t of e)bt(t,t==="GO!"?"#2E7D32":"#C62828"),await new Promise(n=>setTimeout(n,1e3));bt("ğŸ The Race is ON! ğŸ","#1565C0")}function gn(e,t,s,n){const a=d=>d*Math.PI/180,r=a(s-e),i=a(n-t),l=Math.sin(r/2)**2+Math.cos(a(e))*Math.cos(a(s))*Math.sin(i/2)**2;return 6371*2*Math.asin(Math.sqrt(l))}function hs(e,t,s="OPEN"){if(e===void 0||t===void 0)return!1;const n=String(e).trim().toLowerCase(),o=String(t).trim().toLowerCase();if(!n||!o)return!1;switch(s.toUpperCase()){case"YES_NO":case"TRUE_FALSE":case"UP_DOWN":{const a=["yes","y","true","up"],r=["no","n","false","down"];return a.includes(n)&&a.includes(o)||r.includes(n)&&r.includes(o)}case"NUMBER":{const a=parseFloat(n),r=parseFloat(o);return isNaN(a)||isNaN(r)?!1:Math.abs(a-r)<1e-4}case"MULTIPLE_CHOICE":return n===o;case"CSV":return o.split(",").map(r=>r.trim()).includes(n);case"COMPLETE":case"OPEN":return Array.isArray(t)?t.some(a=>n.includes(String(a).trim().toLowerCase())):o.includes(n)||n.includes(o);default:return n===o}}async function he(e="Game Master",t="",s=!0){try{const n=(e==null?void 0:e.trim())||"Game Master",o=typeof t=="string"?t:"";let a=o;const r=o.toLowerCase();r.includes("challenging")?a=`<span style="color:#ff7043; font-weight:bold;">${o}</span>`:r.includes("captured")?a=`<span style="color:#ffd700; font-weight:bold;">${o}</span>`:r.includes("finished")||r.includes("completed")?a=`<span style="color:#00e676; font-weight:bold;">${o}</span>`:a=`<span style="color:#ffffff;">${o}</span>`,await Re(A(p,"communications"),{teamName:n,sender:n,senderDisplay:n,message:a,isBroadcast:s,timestamp:C()}),console.log(`ğŸ“£ Broadcasted from ${n}: ${t}`)}catch(n){console.error("âŒ Broadcast error:",n)}}const ys=(e,t)=>he(e,`is challenging ${t}!`),ws=(e,t)=>he(e,`has captured ${t}!`);async function bs(e,t){try{if(!e||!t){console.warn("âš ï¸ updateTeamLocation called with missing parameters:",{teamName:e,zoneName:t});return}await ge(D(p,"teamStatus",e),{lastKnownLocation:t,timestamp:C()},{merge:!0}),pn(`ğŸ“ ${t} (updated ${new Date().toLocaleTimeString()})`),console.log(`ğŸ“ Updated ${e} location â†’ ${t}`)}catch(s){console.error("âŒ updateTeamLocation error:",s)}}let St=null;function Pt(){if(St||typeof window>"u")return;const e=J(A(p,"communications"),je("timestamp","desc"));St=B(e,t=>{t.docChanges().forEach(s=>{var a;if(s.type!=="added")return;const n=s.doc.id;if(wt.has(n))return;wt.add(n);const o=(((a=s.doc.data())==null?void 0:a.message)||"").toString();hn(o)})})}function hn(e=""){var o;if(!e)return;const t=e.match(/Speed Bump:\s*([^\n]+?)\s+challenged\s+([^\n!]+)!/);if(t){const[,a,r]=t,i=(((o=e.match(/Challenge:\s*([^\n]+)/))==null?void 0:o[1])||"").trim();ot(r.trim(),{by:a.trim(),challenge:i,startedAt:Date.now()});return}const s=e.match(/(?:ğŸŸ¢\s)?Speed Bump Cleared:\s*([^(]+?)(?:\s|\(|$)/);if(s){const a=s[1].trim();at(a,"Comms Listener",{fromComms:!0});return}const n=e.match(/Proof Sent:\s*([^|]+)\|([0-9]+)\|([0-9]+)/);if(n){const[,a,r,i]=n;Cn(a.trim(),Number(r),Number(i));return}}let Ve=null;function yn(e){typeof e=="function"?Ve=e:console.warn("âš ï¸ Invalid release handler passed to registerReleaseHandler")}function wn(e,t){if(!t)return;const s=Math.max(0,t-Date.now()),n=ue.get(e);n!=null&&n.timerId&&clearTimeout(n.timerId);const o=setTimeout(()=>{ue.delete(e),Ve?Ve(e,"Auto Timer"):console.warn("âš ï¸ releaseSpeedBump not yet registered â€” skipping auto release for",e)},s);ue.set(e,{expiresAt:t,timerId:o})}function bn(e){const t=ue.get(e);t!=null&&t.timerId&&clearTimeout(t.timerId),ue.delete(e)}function Sn({by:e="",challenge:t=""}={}){let s=document.getElementById("speedbump-overlay");s||(s=document.createElement("div"),s.id="speedbump-overlay",Object.assign(s.style,{position:"fixed",inset:0,background:"rgba(0,0,0,0.9)",color:"#fff",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",zIndex:6e3}),document.body.appendChild(s)),s.innerHTML=`
dist/assets/playerChat-BxaURsEE.js:13: `}else{const F=et(m),H=F===e,K=H?"#FFD700":"#00CED1",c=H?m.recipient||"Unknown":F||"Unknown",y=H?`<strong style="color:${K};">You â¡ï¸ ${ie(m.recipient||"Unknown")}:</strong>`:`<strong style="color:${K};">${ie(c)} â¡ï¸ You:</strong>`;b.innerHTML=`${y} ${ie(m.text||m.message||"")} <span style="color:#888;">(${x})</span>`}t.appendChild(b)}),t.scrollTop=t.scrollHeight},h=m=>{if(m.empty){i.length=0,l.clear(),d();return}m.docChanges().forEach(S=>{var x;if(S.type==="added"&&!l.has(S.doc.id)){const b=S.doc.data();b.timestamp=(x=b.timestamp)!=null&&x.toMillis?b.timestamp.toMillis():b.timestamp,l.add(S.doc.id),i.push(b)}else if(S.type==="removed"){const b=i.findIndex(O=>O.id===S.doc.id);b!==-1&&i.splice(b,1)}}),d()};return te("playerMessages",B(n,h)),te("playerMessages",B(o,h)),te("playerMessages",B(a,h)),te("playerMessages",B(r,h)),()=>ee("playerMessages")}function Ln(e,t,s,n){console.log(`ğŸ’¥ Reversal: ${s} attacked ${e} mid-Speed-Bump`),vn(e,t,s),he("Game Master",`ğŸ’¥ Instant Karma! ${s} hit ${e} â€” both wrecked!`,!1),setTimeout(()=>{Bt(t),X(),_t(e,"speedBump",Ft),ht(e),ht(t),ot(e,{by:s,challenge:n,startedAt:Date.now()}),Pe(e,"ğŸš§ You hit your own bump!"),Pe(t,"ğŸ› Youâ€™re free!"),Pe(s,"ğŸ˜ˆ Instant Karma delivered!")},fn)}const Tt=["Thanks for the love tap, champ. Hope your GPS leads you into a lake.","Nice play, speed demon. Did your grandma code your strategy?","Appreciate the pit stop â€” I was getting tired anyway.","Congrats, you just made my teamâ€™s group chat way funnier.","Your sabotage skills are strong. Your math skills? Not so much.","That was cute. My grandma drives faster than your Wi-Fi.","Oh great, now my driver thinks the tire light is emotional support.","Weâ€™ll send you the bill â€” and a glitter bomb.","Hey! Was that necessary? (Yes, yes it was.)","Enjoy your lead while it lasts, hotshot.","Still laughing about your â€˜strategy.â€™ Itâ€™s adorable.","We see you. We just donâ€™t respect you.","Is that all you got? My dog could code a better ambush.","Good hit â€” too bad karmaâ€™s got better aim.","We were due for some cardio anyway, thanks!","Flat tire? More like flat performance â€” yours, not ours.","You play dirty, and I respect that.","Thatâ€™s it? My kindergartners prank harder.","Nice move! Weâ€™ll remember thisâ€¦ forever.","Keep it up â€” our memes are getting stronger with every attack."],Oe=Array.isArray(Tt)?[...Tt]:[],$n=["Tow trucks on standby? We'll send flowers to the depot you sent us to.","Appreciate the cardio. Hope your next pit stop comes with jazz hands.","We're airlifting this donut to your depotâ€”care to race us there?","North, south, east, westâ€”whichever compass you picked, we're still coming for you."],In=["Proof incoming. Maybe grab popcorn while you wait.","Consider this the calm before our counter-bump.","We're posing for your challenge like it's a music video.","Hope you enjoy the suspenseâ€”we sure are."];function Ne(e=[],t=[]){return Object.freeze([...e,...t].filter(Boolean))}const Et=Object.freeze({general:Ne(Oe),flatTire:Ne(Oe,$n),speedBump:Ne(Oe,In)});function Dn(e="general"){const t=typeof e=="string"?e.trim().toLowerCase():"general";return Et[t]||Et.general}function Ss(e="general"){const t=Dn(e);if(!t.length)return"Nice moveâ€”game on!";const s=Math.floor(Math.random()*t.length);return t[s]||"Nice moveâ€”game on!"}let we=null;function ot(e,t){if(!e||!t)return;const s=e.trim();if(!s)return;const n={...t,by:L(t.by),challenge:L(t.challenge),startedAt:t.startedAt??Date.now(),contactEmail:t.contactEmail?L(t.contactEmail):null,contactPhone:t.contactPhone?L(t.contactPhone):null};Q.set(s,n),_t(s,"speedBump",Ft),X()}function Cn(e,t,s=Date.now()){const n=Q.get(e);n&&(Q.set(e,{...n,proofSentAt:s,countdownEndsAt:t}),wn(e,t),X())}function X(){const e={activeBumps:Array.from(Q.entries()),cooldowns:Array.from(se.entries())};Ze.forEach(t=>{try{t(e)}catch(s){console.warn("âš ï¸ speedBump notify error:",s)}})}async function at(e,t="Game Master",{fromComms:s=!1}={}){const n=(e||"").trim();if(!n)return;Pt(),bn(n),Bt(n),Q.delete(n);const o=L(e)||n,a=L(t)||t||"Game Master";s||await he("Game Master",`ğŸŸ¢ Speed Bump Cleared: ${o} (by ${a})`,!0),X()}yn(at);function At(e,t,s=Qe){const n=(e||"").trim(),o=t.trim()||"generic";if(!n)return;const a=`${n}:${o}`;se.set(a,Date.now()+s),xn(),X()}function tt(e,t){const s=(e||"").trim(),n=t.trim()||"generic";if(!s)return 0;const o=`${s}:${n}`,a=se.get(o);return a?Math.max(0,a-Date.now()):0}function xn(){we||(we=setInterval(()=>{const e=Date.now();let t=!1;for(const[s,n]of se)n<=e&&(se.delete(s),t=!0);t&&X(),se.size||(clearInterval(we),we=null)},1e3))}function rt(e){const t=(e||"").trim();if(!t)return null;const s=Q.get(t);if(!s)return null;const n=s.countdownEndsAt?Math.max(s.countdownEndsAt-Date.now(),0):null;return{...s,countdownMs:n}}function it(e){return typeof e!="function"?()=>{}:(Ze.add(e),X(),()=>Ze.delete(e))}function Rn(e,t){if(!e||typeof t!="function")return()=>{};const s=L(e)||e;return it((n={})=>{const o=Date.now(),a=(n.activeBumps||[]).map(([r,i])=>({teamName:r,...i||{}})).filter(r=>r.by===s).map(r=>{const i=r.countdownEndsAt??(r.startedAt?r.startedAt+dn:null),l=i?Math.max(0,i-o):0;return{toTeam:r.teamName,remainingMs:l}});try{t(a)}catch{}})}async function _n(e,t,s,{override:n=!1}={}){Pt();const o=(e||"").trim(),a=(t||"").trim();if(!o||!a)return{ok:!1,reason:"missing_team"};if(un(o))return{ok:!1,reason:"cooldown"};if(gt(o))return{ok:!1,reason:"attacker_busy"};if(gt(a))return{ok:!1,reason:"target_busy"};if(ae(o)){let F=!0;if(typeof window<"u"&&typeof window.confirm=="function"&&(F=window.confirm("Now why would you get that new Polish tarnished with those dirty deeds? Proceeding will cancel your Shield."),!F))return{ok:!1,reason:"shield_cancelled"};nn(o)}const r=(s||"").trim()||"Complete a surprise photo challenge!",i=L(o)||o,l=L(a)||a,d=L(r),h=Bn(a);if(h&&!n)return Ln(a,h.victimTeam,o,d),At(o,"bump",Qe),{ok:!0,reason:"reversal_triggered"};const{email:m,phone:S}=Fn(o),x=m?L(m):"",b=S?L(S):"",O=[`ğŸš§ Speed Bump: ${i} challenged ${l}!`,"",`Challenge: ${d}`];return x&&O.push("",`Contact Email: ${x}`),b&&O.push("",`Contact Phone: ${b}`),O.push("","Reply with a proof photo/video to clear your Speed Bump!"),await he("Game Master",O.join(`
dist/assets/playerChat-BxaURsEE.js:14: `),!0),ot(a,{by:o,challenge:d,startedAt:Date.now(),contactEmail:x||null,contactPhone:b||null}),At(o,"bump",n?0:Qe),{ok:!0}}function Bn(e){const t=(e||"").trim();if(!t)return null;const s=L(t);for(const[n,o]of Q.entries())if((o==null?void 0:o.by)===s)return{victimTeam:n,data:o};return null}function Fn(e){const t=mn(e),s=t!=null&&t.email?L(String(t.email).trim()):"",n=t!=null&&t.phone?L(String(t.phone).trim()):"";return{email:s,phone:n}}const $e=["Pose with a city landmark making your best victory face.","Grab a photo with a stranger wearing your team color.","Stage a slow-motion action shot crossing a finish line.","Snap your team acting out a famous movie scene.","Find a mural and recreate it with your team as props.","Capture a teammate balancing something silly on their head.","Photograph your team forming the shape of a letter R.","Take a photo with a passerby giving a thumbs-up.","Document a creative â€œcar repairâ€ using items nearby.","Take a selfie with everyone making the same goofy expression."];let Ie=[...$e];function Pn(e=[]){if(!Array.isArray(e))return[...$e];const t=e.map(s=>typeof s=="string"?s.trim():"").filter(Boolean);return t.length?t:[...$e]}function Ms(e=[]){return Ie=Pn(e),On()}function On(){return[...Ie]}function Nn(e=[]){const t=new Set(e||[]),s=Ie.filter(a=>!t.has(a)),n=s.length?s:Ie;if(!n.length)return"";const o=Math.floor(Math.random()*n.length);return n[o]}function vs(){return[...$e]}const Be=A(p,"flatTireAssignments"),Nt=D(p,"settings","flatTireConfig"),Wt=100,ne=200,Lt={north:{name:"North Repair Depot",gps:"",diameterMeters:ne},south:{name:"South Repair Depot",gps:"",diameterMeters:ne},east:{name:"East Repair Depot",gps:"",diameterMeters:ne},west:{name:"West Repair Depot",gps:"",diameterMeters:ne}};function ct(e=""){return e.replace(/[^\w\d]+/g,"_").toLowerCase()}function kt(e=""){if(typeof e!="string")return null;const[t,s]=e.split(","),n=Number.parseFloat(t),o=Number.parseFloat(s);return!Number.isFinite(n)||!Number.isFinite(o)?null:{lat:n,lng:o}}function Wn(e="",t={}){const s=kt(e);return!s||!Number.isFinite(t.lat)||!Number.isFinite(t.lng)?Number.POSITIVE_INFINITY:gn(s.lat,s.lng,t.lat,t.lng)*1e3}function Ts(e="",t={}){const s=Wn(e,t);return Number.isFinite(s)&&s<=Wt}function De(e,t=Date.now()){if(e instanceof He)return e;const s=typeof e=="number"?e:Date.parse(e),n=Number.isFinite(s)?s:t;return He.fromMillis(n)}function kn(e,t={}){const s=t.assignedAt??Date.now(),n=t.autoReleaseAt??s+(t.autoReleaseMinutes??20)*6e4,o=Number.isFinite(t.lat)?Number(t.lat):null,a=Number.isFinite(t.lng)?Number(t.lng):null,r=kt(t.gps),i=Number.isFinite(o)?o:(r==null?void 0:r.lat)??null,l=Number.isFinite(a)?a:(r==null?void 0:r.lng)??null;let d=Number(t.diameterMeters);if(!Number.isFinite(d)||d<=0){const S=Number(t.diameter);Number.isFinite(S)&&S>0&&(d=S*1e3)}(!Number.isFinite(d)||d<=0)&&(d=ne);const h=typeof t.assignedBy=="string"&&t.assignedBy.trim()?t.assignedBy.trim():typeof t.fromTeam=="string"&&t.fromTeam.trim()?t.fromTeam.trim():"Game Control",m=t.depotId||t.zoneKey||null;return{teamName:e,zoneKey:t.zoneKey||null,depotId:m,zoneName:t.zoneName||"",gps:t.gps||"",lat:i,lng:l,diameterMeters:d,captureRadiusMeters:t.captureRadiusMeters||Wt,status:t.status||"assigned",notes:t.notes||"",distanceRemainingKm:typeof t.distanceRemainingKm=="number"?Math.max(0,t.distanceRemainingKm):null,assignedBy:h,diameter:d/1e3,assignedAt:De(s,Date.now()),autoReleaseAt:De(n,s+20*6e4),updatedAt:C()}}function zt(e={}){const t={...Lt,...e.zones||{}};Object.keys(t).forEach(n=>{var d;const o=t[n]||{},a=typeof o.name=="string"&&o.name.trim()?o.name.trim():((d=Lt[n])==null?void 0:d.name)||`Zone ${n.toUpperCase()}`,r=typeof o.gps=="string"?o.gps.trim():"";let i=Number(o.diameterMeters);if(!Number.isFinite(i)||i<=0){const h=Number(o.diameter);Number.isFinite(h)&&h>0&&(i=h*1e3)}(!Number.isFinite(i)||i<=0)&&(i=ne);const l={name:a,gps:r,diameterMeters:i,diameter:i/1e3};Number.isFinite(o.lat)&&(l.lat=Number(o.lat)),Number.isFinite(o.lng)&&(l.lng=Number(o.lng)),t[n]=l});const s=typeof e.autoIntervalMinutes=="number"&&e.autoIntervalMinutes>0?Math.round(e.autoIntervalMinutes):15;return{zones:t,autoIntervalMinutes:s}}function Es(e){return B(Be,t=>{const s=t.docs.map(n=>{var a,r,i,l,d,h;const o=n.data();return{id:n.id,...o,assignedAtMs:((r=(a=o.assignedAt)==null?void 0:a.toMillis)==null?void 0:r.call(a))??null,autoReleaseAtMs:((l=(i=o.autoReleaseAt)==null?void 0:i.toMillis)==null?void 0:l.call(i))??null,updatedAtMs:((h=(d=o.updatedAt)==null?void 0:d.toMillis)==null?void 0:h.call(d))??null}});e==null||e(s)})}function As(e){return B(Nt,t=>{const s=t.exists()?t.data():{};e==null||e(zt(s))})}async function zn(){const e=await pe(Nt);return zt(e.exists()?e.data():{})}async function Un(e,t={}){if(!e)throw new Error("teamName is required to assign Flat Tire.");const s=D(Be,ct(e)),n=kn(e,t);return await ge(s,n),n}async function Ls(e,t={}){if(!e)throw new Error("teamName is required to update Flat Tire assignment.");const s=D(Be,ct(e)),n={...t,updatedAt:C()};n.autoReleaseAt&&(n.autoReleaseAt=De(n.autoReleaseAt)),n.assignedAt&&(n.assignedAt=De(n.assignedAt)),await ge(s,n,{merge:!0})}async function $s(e){if(!e)return;const t=D(Be,ct(e));await It(t)}const be=new Map,U=new Map,W=new Map;function ye(e){return typeof e!="string"?"":e.trim()}async function Gn(e){const t=ye(e);if(!t)return e??"";if(be.has(t))return be.get(t);try{const s=D(p,"zones",t),n=await pe(s);if(n.exists()){const o=n.data()||{},a=o.displayName||o.name||t;return be.set(t,a),a}}catch(s){console.warn("âš ï¸ Zone name lookup failed for",t,s)}return be.set(t,t),t}function Hn(e){if(!e)return null;if(typeof e=="number")return e;if(typeof e=="string"){const t=Number(e);return Number.isFinite(t)?t:null}return typeof e.toMillis=="function"?e.toMillis():e.seconds?e.seconds*1e3+Math.floor((e.nanoseconds||0)/1e6):null}function Ut(e,t){var o,a;if(!e||!Number.isFinite(t))return;const s=t-Date.now();if(s<=0){(o=W.get(e))==null||o(),W.delete(e),U.delete(e);return}(a=W.get(e))==null||a();const n=setTimeout(()=>{W.delete(e);const r=U.get(e);r&&r<=Date.now()&&U.delete(e)},s+25);W.set(e,()=>clearTimeout(n))}function Is(e,t){var o;const s=ye(e),n=Hn(t);if(!(!s||!n)){if(n<=Date.now()){U.delete(s),(o=W.get(s))==null||o(),W.delete(s);return}U.set(s,n),Ut(s,n)}}async function Ds(e,t=15,{persist:s=!0}={}){const n=ye(e),o=Number.isFinite(t)?Math.max(0,t):0;if(!n||o<=0)return null;const a=Date.now()+o*60*1e3;if(U.set(n,a),Ut(n,a),console.log(`â³ Cooldown started for ${n} (${o} min)`),s)try{await ge(D(p,"zones",n),{cooldownUntil:a,cooldownMinutes:o},{merge:!0})}catch(r){console.warn("âš ï¸ Failed to persist cooldown for",n,r)}return a}function Cs(e){var n;const t=ye(e);if(!t)return!1;const s=U.get(t);return s?s<=Date.now()?(U.delete(t),(n=W.get(t))==null||n(),W.delete(t),!1):!0:!1}function xs(e){var o;const t=ye(e);if(!t)return 0;const s=U.get(t);if(!s)return 0;const n=s-Date.now();return n<=0?(U.delete(t),(o=W.get(t))==null||o(),W.delete(t),0):n}async function Rs(e,t){if(!e||typeof t!="number")return;const s=fe.find(a=>a.name===e),n=s?s.name:e,o=D(p,"scores",n);try{await xe(p,async a=>{const r=await a.get(o),l=(r.exists()&&r.data().score||0)+t;a.set(o,{score:l,updatedAt:C()},{merge:!0})}),console.log(`âœ… Score updated: ${n} â†’ ${t>=0?"+":""}${t}`)}catch(a){console.error(`âŒ Failed to update score for ${n}:`,a)}}async function _s(e,t){if(!e||!t)return;const s=fe.find(a=>a.name===e),n=s?s.name:e,o=D(p,"scores",n);try{await ge(o,{zonesControlled:t,updatedAt:C()},{merge:!0}),console.log(`ğŸ“ ${n} now controls zone: ${t}`)}catch(a){console.error(`âŒ Failed to update controlled zones for ${n}:`,a)}}async function Bs(){try{console.log("ğŸ§¹ Resetting all team scores and zone ownership...");const e=qt(p);(await Ae(A(p,"scores"))).forEach(n=>{e.set(D(p,"scores",n.id),{score:0,zonesControlled:"â€”",updatedAt:C()},{merge:!0})}),(await Ae(A(p,"zones"))).forEach(n=>{e.set(D(p,"zones",n.id),{status:"Available",controllingTeam:null,updatedAt:C()},{merge:!0})}),await e.commit(),console.log("âœ… All scores and zones successfully reset.")}catch(e){console.error("âŒ Failed to reset scores/zones:",e)}}function Fs(){const e=document.getElementById("player-scoreboard-tbody");if(!e)return;const t=A(p,"scores");B(t,s=>{const n=[];s.forEach(o=>{const a=o.data();n.push({name:o.id,score:a.score||0,zonesControlled:a.zonesControlled||"â€”"})}),n.sort((o,a)=>(a.score||0)-(o.score||0)),e.innerHTML="",n.forEach((o,a)=>{const r=a===0?"ğŸ¥‡":a===1?"ğŸ¥ˆ":a===2?"ğŸ¥‰":"",i=document.createElement("tr");i.innerHTML=`
dist/assets/playerChat-BxaURsEE.js:43: `,e.insertAdjacentElement("afterend",t)),t.previousElementSibling!==e&&e.insertAdjacentElement("afterend",t);const s=t.querySelector("#team-surprise-inventory");s&&!s.innerHTML.trim()&&(s.innerHTML='<li class="team-surprises-empty">No surprise data yet.</li>');const n=t.querySelector("#outgoing-speedbump-list");n&&!n.innerHTML.trim()&&(n.innerHTML='<li class="team-surprises-empty">No active Speed Bumps.</li>');const o=t.querySelector("#team-surprises-body");return o&&!o.innerHTML.trim()&&(o.innerHTML='<p class="team-surprises-placeholder">Loading your wild cardsâ€¦</p>'),t}function ze(e={},...t){for(const s of t)if(s in e){const n=Number(e[s]);if(Number.isFinite(n)&&n>=0)return n}return 0}function Zn(e={}){const t=M.inventoryList;if(!t)return;const s=Object.entries(e);if(!s.length){t.innerHTML='<li class="team-surprises-empty">No surprise data yet.</li>';return}s.sort((o,a)=>o[0].localeCompare(a[0]));const n=s.map(([o,a={}])=>{const r=ze(a,u.FLAT_TIRE,"flatTire"),i=ze(a,u.BUG_SPLAT,"bugSplat"),l=ze(a,u.WILD_CARD,"wildCard","superShieldWax");return`
dist/assets/playerChat-BxaURsEE.js:81: `,t.appendChild(y)});const h=({flatTire:c=0,bugSplat:y=0,superShieldWax:f=0}={})=>{if(!n)return;const v=ae(e),g=Ye(e),w=k(String(c)),R=k(String(y)),E=k(String(f)),$=v?`<div class="shield-status shield-active">ğŸ›¡ï¸ Active: ${Math.ceil(g/1e3)}s</div>`:f>0?'<button id="activate-shield-btn" class="shield-activate-btn">ğŸ›¡ï¸ Activate Super SHIELD Wax</button>':'<div class="shield-status shield-empty">No SHIELD Wax remaining</div>';n.innerHTML=`
dist/assets/playerChat-BxaURsEE.js:97: `;const G=document.getElementById("activate-shield-btn");G&&(G.onclick=async()=>{if(G.disabled=!0,!await rn(e,u.WILD_CARD,1)){G.disabled=!1;return}Ke(e);const Ht=Ye(e);Mt(Ht),o==null||o.refreshShieldStatus()}),v&&g>0?Mt(g):v||de(),o==null||o.refreshShieldStatus()};n&&(h(),a=an(e,(c={})=>{var y,f,v,g;h({flatTire:c.flatTire??((y=c.counts)==null?void 0:y.flatTire)??0,bugSplat:c.bugSplat??((f=c.counts)==null?void 0:f.bugSplat)??0,superShieldWax:c.superShieldWax??((v=c.counts)==null?void 0:v.superShieldWax)??((g=c.counts)==null?void 0:g.wildCard)??0})}));const m=(c=[])=>{const y=new Map;c.forEach(f=>{f!=null&&f.toTeam&&y.set(f.toTeam,Math.max(0,Number(f.remainingMs)||0))}),t.querySelectorAll("tr[data-team]").forEach(f=>{const v=f.dataset.team,g=f.querySelector(".outgoing-bump-timer"),w=f.querySelector(".speedbump-send-btn"),R=y.get(v);if(R!==void 0){if(!g){const $=document.createElement("span");$.className="outgoing-bump-timer",$.textContent="";const G=f.querySelector(".speedbump-actions")||f.lastElementChild;G&&G.appendChild($)}const E=f.querySelector(".outgoing-bump-timer");if(E){const $=Math.ceil(R/1e3);E.textContent=$>0?`â³ ${$}s`:"â³ Active"}w&&(w.disabled=!0,w.title="Speed bump active â€” wait for completion")}else g==null||g.remove(),w&&!w.disabled&&(w.title="")}),ce(e)},S=A(p,"teamStatus"),x=B(S,async c=>{if(c.empty){t.querySelectorAll(".last-location").forEach(f=>{f.textContent="--"});return}const y=c.docChanges();await Promise.all(y.map(async f=>{const v=f.doc.id,g=t.querySelector(`[data-team="${v}"]`);if(!g)return;const w=g.querySelector(".last-location");if(w){if(f.type==="removed")w.textContent="--";else if(f.type==="added"||f.type==="modified"){const R=f.doc.data(),E=typeof R.lastKnownLocation=="string"?R.lastKnownLocation.trim():"";let $="--";if(E)try{$=await Gn(E)}catch(G){console.warn("âš ï¸ Zone label fallback for",E,G),$=E}w.textContent=$}}}))});te("player",x),t.addEventListener("click",async c=>{const y=c.target.closest(".send-btn");if(y){const w=y.dataset.recipient,R=document.querySelector(`input[data-recipient-input="${w}"]`),E=R.value.trim();if(!E)return;R.value="";try{typeof window.sendTeamMessage=="function"?window.sendTeamMessage(w,E):window.chatManager&&typeof window.chatManager.sendTeamMessage=="function"?window.chatManager.sendTeamMessage(w,E):st(e,w,E)}catch($){console.error("ğŸ’¥ Error sending message:",$)}return}const f=c.target.closest(".speedbump-send-btn");if(f){const w=f.dataset.target;await jn(e,w),ce(e);return}const v=c.target.closest(".speedbump-release-btn");if(v){const w=v.dataset.target;await qn(w,e),ce(e)}const g=c.target.closest('button[data-action="use-surprise"]');if(g){const w=g.dataset.type,R=g.closest("tr[data-team]");if(!R)return;const E=R.dataset.team;await ns(e,E,w)}}),(H=N.unsubscribe)==null||H.call(N),N.current=e,N.unsubscribe=it(()=>ce(e)),ce(e),(K=P.unsubscribe)==null||K.call(P),P.counts=new Map,P.unsubscribe=sn((c=[],y=null)=>{const f=new Map;c.forEach(g=>{f.set(g.teamName,g.counts||{})}),P.counts=f,ts(e);const v=y||Object.fromEntries(c.map(g=>[g.teamName,g.counts||{}]));o==null||o.renderInventory(v),o==null||o.refreshShieldStatus()}),m([]),o==null||o.renderOutgoing([]),r==null||r(),r=Rn(e,(c=[])=>{m(c),o==null||o.renderOutgoing(c)});const b=J(A(p,"communications"),qe("type","==","shieldWax")),O=B(b,c=>{c.docChanges().forEach(y=>{if(y.type==="removed")return;const f=y.doc.data()||{},v=f.to||f.targetTeam||f.recipient||f.teamName;let g=f.shieldExpiresAt;g&&typeof g.toMillis=="function"&&(g=g.toMillis()),v&&(Ke(v,g),v===e&&(o==null||o.refreshShieldStatus()))})});te("player",O);const F=An(e,s);return()=>{var c,y;ee("player"),ee("playerMessages"),F==null||F(),(c=N.unsubscribe)==null||c.call(N),N.unsubscribe=null,N.current=null,(y=P.unsubscribe)==null||y.call(P),P.unsubscribe=null,a==null||a(),a=null,r==null||r(),r=null,o==null||o.teardown(),de()}}function ce(e){N.current&&document.querySelectorAll("#opponents-tbody tr[data-team]").forEach(t=>{const s=t.dataset.team,n=t.querySelector(".speedbump-send-btn"),o=t.querySelector(".speedbump-release-btn");if(!n||!o)return;const a=tt(e,"bump");a>0?(n.disabled=!0,n.title=`Cooldown ${Math.ceil(a/1e3)}s`):(n.disabled=!1,n.title="");const r=rt(s),i=r&&r.by===e,l=r&&s===e&&(r.countdownMs?r.countdownMs<=0:!!r.proofSentAt),d=!!r&&(i||l);o.disabled=!d,i?o.title="Release speed bump":l?o.title="Countdown finished â€” self-release available.":o.title="Release becomes available after the proof timer finishes."})}function Ge(e){const t=e===u.FLAT_TIRE?"ğŸš—":e===u.BUG_SPLAT?"ğŸ":"ğŸ›¡ï¸",s=e===u.FLAT_TIRE?"Flat Tire":e===u.BUG_SPLAT?"Bug Splat":"Super SHIELD Wax";return`
dist/assets/playerChat-BxaURsEE.js:104: `}function ts(e){const t=P.counts.get(e)||{};document.querySelectorAll("#opponents-tbody tr[data-team]").forEach(s=>{Gt.forEach(n=>{const o=s.querySelector(`[data-role="surprise-count-${n}"]`),a=s.querySelector(`button[data-action="use-surprise"][data-type="${n}"]`),r=Number(t[n]||0);o&&(o.textContent=String(r)),a&&(a.disabled=r<=0)})})}async function ns(e,t,s){if(!s||!Gt.includes(s))return;if(e===t){alert("Cannot use a surprise on your own team.");return}if(((P.counts.get(e)||{})[s]||0)<=0){alert("No surprises remaining. Control can issue more.");return}if(s!==u.WILD_CARD&&ae(t)){console.log(`ğŸ§¼ Attack from ${e} blocked â€” ${t} is shielded.`),await En(e,Kn);return}try{s===u.FLAT_TIRE?await ss(e,t):s===u.BUG_SPLAT?await os(e,t):s===u.WILD_CARD&&await as(e,t),await Rt(e,s)}catch(a){console.error("âŒ Failed to use surprise:",a),alert(`Surprise failed: ${a.message||a}`)}}async function ss(e,t){const s=await zn(),n=Object.entries(s.zones||{}).filter(([,h])=>h==null?void 0:h.gps);if(!n.length)throw new Error("No tow zones are configured yet. Ping Control.");const[o,a]=n[Math.floor(Math.random()*n.length)],r=typeof a.gps=="string"?a.gps.split(","):[],i=Number.parseFloat(r[0]),l=Number.parseFloat(r[1]),d=Number.isFinite(a.diameterMeters)&&a.diameterMeters>0?a.diameterMeters:Number.isFinite(a.diameter)&&a.diameter>0?a.diameter*1e3:200;await Un(t,{zoneKey:o,depotId:o,zoneName:a.name,gps:a.gps,lat:Number.isFinite(i)?i:null,lng:Number.isFinite(l)?l:null,diameterMeters:d,assignedAt:Date.now(),autoReleaseMinutes:20,status:"player-surprise",assignedBy:e,fromTeam:e}),await lt(`${e} deployed a Flat Tire surprise on ${t}!`,{type:"flatTire",from:e,to:t})}async function os(e,t){await lt(`ğŸª° ${e} splatted ${t} with a Bug Splat!`,{type:"bugStrike",from:e,to:t,isBroadcast:!0})}async function as(e,t){const s=Ke(t),n=es();await lt(`ğŸ›¡ï¸ ${e} coated ${t} in Super SHIELD Wax! Attacks bounce off for ${n} minute${n===1?"":"s"}.`,{type:"shieldWax",from:e,to:t,isBroadcast:!0,shieldExpiresAt:s,shieldDurationMinutes:n})}async function lt(e,t={}){await Re(A(p,"communications"),{teamName:t.from||"Game Master",sender:t.from||"Game Master",senderDisplay:t.from||"Game Master",message:e,timestamp:C(),...t})}export{ae as $,fs as A,Ye as B,ee as C,te as D,et as E,ie as F,V as G,Tn as H,Bs as I,Xt as J,Ps as K,Me as L,Vt as M,T as N,Se as O,ys as P,hs as Q,bs as R,u as S,ws as T,Ds as U,ps as V,gs as W,gn as X,pn as Y,gt as Z,dt as _,fe as a,Pe as a0,Ss as a1,Wn as a2,Ts as a3,Wt as a4,Ls as a5,he as a6,$s as a7,Ns as a8,Fs as a9,Os as aa,it as ab,ls as ac,us as ad,tt as b,vs as c,Nn as d,k as e,On as f,rt as g,_n as h,at as i,Un as j,As as k,zn as l,Es as m,Is as n,Cs as o,Zt as p,xs as q,Qt as r,Ms as s,Gn as t,_s as u,Rs as v,_ as w,ms as x,sn as y,ds as z};
modules/chatManager/playerChat.js:39: } from '../flatTireManager.js';
modules/chatManager/playerChat.js:151: const flat = extractSurpriseCount(counts, SurpriseTypes.FLAT_TIRE, 'flatTire');
modules/chatManager/playerChat.js:344: const renderPlayerSurprises = ({ flatTire = 0, bugSplat = 0, superShieldWax = 0 } = {}) => {
modules/chatManager/playerChat.js:348: const flatDisplay = escapeHtml(String(flatTire));
modules/chatManager/playerChat.js:405: flatTire: snapshot.flatTire ?? snapshot.counts?.flatTire ?? 0,
modules/chatManager/playerChat.js:730: type: 'flatTire',
modules/controlActions.js:201: const targets = ["flatTireAssignments", "teamSurprises", "shields"];
modules/flatTireManager.js:2: // FILE: modules/flatTireManager.js
modules/flatTireManager.js:23: const ASSIGNMENTS_COLLECTION = collection(db, 'flatTireAssignments');
modules/flatTireManager.js:24: const CONFIG_DOCUMENT = doc(db, 'settings', 'flatTireConfig');
modules/flatTireManager.js:230: export const __flatTireDefaults = Object.freeze({
modules/flatTireUI.js:2: // FILE: modules/flatTireUI.js
modules/flatTireUI.js:14: } from './flatTireManager.js';
modules/flatTireUI.js:183: onChirp: () => sendPrivateMessage(teamName, assignedBy, getRandomTaunt('flatTire')),
modules/flatTireUI.js:195: console.info(`ğŸ§¹ [flatTireUI] cleaned up (${reason})`);
modules/gameRulesManager.js:258: const flatTireCol = collection(db, 'flatTireAssignments');
modules/gameRulesManager.js:268: await wipe(flatTireCol);
modules/gameRulesManager.js:288: "flatTireAssignments",
modules/messages/taunts.js:10: const flatTireExtras = [
modules/messages/taunts.js:30: flatTire: mergeTaunts(baseTaunts, flatTireExtras),
modules/playerUI/overlays/flatTireOverlay.js:4: import { generateMiniMap } from '../../zonesMap.js';
modules/playerUI/overlays/flatTireOverlay.js:56: const mapHtml = generateMiniMap({ gps, diameter: diameterMeters / 1000 });
modules/playerUI/overlays.js:4: export * from './overlays/flatTireOverlay.js';
modules/playerUI/overlays_FULL.js:6: import { generateMiniMap } from '../zonesMap.js';
modules/playerUI/overlays_FULL.js:49: let flatTireCountdownInterval = null;
modules/playerUI/overlays_FULL.js:50: let flatTireAutoReleaseTriggered = false;
modules/playerUI/overlays_FULL.js:418: flatTireAutoReleaseTriggered = false;
modules/playerUI/overlays_FULL.js:450: mapWrapper.innerHTML = generateMiniMap({
modules/playerUI/overlays_FULL.js:534: if (flatTireAutoReleaseTriggered) return;
modules/playerUI/overlays_FULL.js:535: flatTireAutoReleaseTriggered = true;
modules/playerUI/overlays_FULL.js:541: if (flatTireCountdownInterval) {
modules/playerUI/overlays_FULL.js:542: clearInterval(flatTireCountdownInterval);
modules/playerUI/overlays_FULL.js:543: flatTireCountdownInterval = null;
modules/playerUI/overlays_FULL.js:558: clearInterval(flatTireCountdownInterval);
modules/playerUI/overlays_FULL.js:559: flatTireCountdownInterval = null;
modules/playerUI/overlays_FULL.js:567: flatTireCountdownInterval = setInterval(updateCountdown, 1000);
modules/playerUI/overlays_FULL.js:614: if (flatTireCountdownInterval) {
modules/playerUI/overlays_FULL.js:615: clearInterval(flatTireCountdownInterval);
modules/playerUI/overlays_FULL.js:616: flatTireCountdownInterval = null;
modules/teamSurpriseManager.js:20: FLAT_TIRE: 'flatTire',
modules/teamSurpriseManager.js:162: const flat = normalizeCount(counts[SurpriseTypes.FLAT_TIRE] ?? counts.flatTire);
modules/teamSurpriseManager.js:167: flatTire: flat,
modules/teamSurpriseManager.js:225: if (key === SurpriseTypes.FLAT_TIRE || key === 'flatTire') return SurpriseTypes.FLAT_TIRE;
modules/zones.js:19: import { generateMiniMap } from './zonesMap.js';
modules/zones.js:64: const zonesCollection = collection(db, 'zones');
modules/zones.js:92: registerZoneListener('zonesCollection', onSnapshot(zonesCollection, (snapshot) => {
modules/zones.js:109: <td>${generateMiniMap(zone)}</td>
modules/zonesMap.js:88: export function generateMiniMap(zoneData = {}) {
player.js:23: import { initializeFlatTireUI } from './modules/flatTireUI.js';
player.js:30: let flatTireCleanup = null;
player.js:46: flatTireCleanup?.(reason);
player.js:47: flatTireCleanup = null;
player.js:101: flatTireCleanup = initializeFlatTireUI(currentTeamName);

ğŸ§© DOM Hooks & Select Elements
=============================
components/FlatTireControl/controller/domHandlers.js:17: const btn = document.querySelector(`button[data-role="refresh"][data-zone="${key}"]`);
components/FlatTireControl/flatTireControlController_FULL.js:179: const refreshBtn = document.querySelector(`button[data-role="refresh"][data-zone="${key}"]`);
components/FlatTireControl/flatTireControlController_FULL.js:286: const card = document.querySelector(`.${styles.zoneCard}[data-zone="${key}"] h3`);
components/FlatTireControl/flatTireControlController_FULL.js:571: const select = row.querySelector('select[data-role="zone-select"]');
components/FlatTireControl/flatTireControlController_FULL.js:704: const zoneSelect = row.querySelector('select[data-role="zone-select"]');

ğŸ”¥ Firestore Listeners & Snapshots
=================================
modules/bugStrikeManager.js:173: const snap = await getDocs(STRIKE_COLLECTION);
modules/bugStrikeManager.js:193: const snap = await getDocs(STRIKE_COLLECTION);
modules/chatManager/controlFeed.js:12: onSnapshot,
modules/chatManager/controlFeed.js:85: registerListener('control', onSnapshot(privateMessagesQuery, processSnapshot));
modules/chatManager/controlFeed.js:86: registerListener('control', onSnapshot(publicCommsQuery, processSnapshot));
modules/chatManager/controlFeed.js:87: registerListener('control', onSnapshot(controlAllQuery, processSnapshot));
modules/chatManager/messageService.js:11: onSnapshot,
modules/chatManager/messageService.js:151: registerListener('playerMessages', onSnapshot(sentQuery, processSnapshot));
modules/chatManager/messageService.js:152: registerListener('playerMessages', onSnapshot(receivedQuery, processSnapshot));
modules/chatManager/messageService.js:153: registerListener('playerMessages', onSnapshot(broadcastQuery, processSnapshot));
modules/chatManager/messageService.js:154: registerListener('playerMessages', onSnapshot(controlAllQuery, processSnapshot));
modules/chatManager/playerChat.js:12: onSnapshot,
modules/chatManager/playerChat.js:453: const teamStatusUnsub = onSnapshot(teamStatusCol, async (snapshot) => {
modules/chatManager/playerChat.js:569: const shieldUnsub = onSnapshot(shieldQuery, (snapshot) => {
modules/controlActions.js:32: const scoresSnap = await getDocs(collection(db, "scores"));
modules/controlActions.js:39: const teamStatusSnap = await getDocs(collection(db, "teamStatus"));
modules/controlActions.js:103: const zonesSnap = await getDocs(collection(db, "zones"));
modules/controlActions.js:114: const teamStatusSnap = await getDocs(collection(db, "teamStatus"));
modules/controlActions.js:182: const teamStatusSnap = await getDocs(collection(db, "teamStatus"));
modules/controlActions.js:204: const snap = await getDocs(collection(db, colName));
modules/controlStatus.js:15: onSnapshot,
modules/controlStatus.js:76: const unsub = onSnapshot(teamStatusRef, async (snapshot) => {
modules/controlStatus.js:119: const commSnap = await getDocs(collection(db, 'communications'));
modules/controlStatus.js:125: const controlSnap = await getDocs(collection(db, 'conversations', 'CONTROL_ALL', 'messages'));
modules/controlStatus.js:131: const convoSnap = await getDocs(collection(db, 'conversations'));
modules/controlStatus.js:134: const msgSnap = await getDocs(collection(db, 'conversations', docSnap.id, 'messages'));
modules/controlStatus.js:187: const snapshot = await getDocs(teamStatusRef);
modules/controlStatus.js:209: const snapshot = await getDocs(zonesRef);
modules/flatTireManager.js:13: onSnapshot,
modules/flatTireManager.js:23: const ASSIGNMENTS_COLLECTION = collection(db, 'flatTireAssignments');
modules/flatTireManager.js:165: return onSnapshot(ASSIGNMENTS_COLLECTION, (snapshot) => {
modules/flatTireManager.js:181: return onSnapshot(CONFIG_DOCUMENT, (docSnap) => {
modules/gameMaintenance.js:41: const racersSnap = await getDocs(collection(db, 'racers'));
modules/gameMaintenance.js:45: const zonesSnap = await getDocs(collection(db, 'zones'));
modules/gameMaintenance.js:53: const scoresSnap = await getDocs(collection(db, 'scores'));
modules/gameMaintenance.js:73: const comms = await getDocs(collection(db, 'communications'));
modules/gameMaintenance.js:74: const scores = await getDocs(collection(db, 'scores'));
modules/gameMaintenance.js:90: const teamSnap = await getDocs(collection(db, 'teamStatus'));
modules/gameRulesManager.js:17: onSnapshot
modules/gameRulesManager.js:50: onSnapshot(gameDocRef, (docSnap) => {
modules/gameRulesManager.js:83: const snap = await getDocs(collection(db, 'racers'));
modules/gameRulesManager.js:110: const racersSnap = await getDocs(collection(db, 'racers'));
modules/gameRulesManager.js:149: const racersSnap = await getDocs(collection(db, 'racers'));
modules/gameRulesManager.js:186: const scoresSnap = await getDocs(collection(db, 'scores'));
modules/gameRulesManager.js:240: const racers = await getDocs(collection(db, 'racers'));
modules/gameRulesManager.js:243: const zones = await getDocs(collection(db, 'zones'));
modules/gameRulesManager.js:246: const scores = await getDocs(collection(db, 'scores'));
modules/gameRulesManager.js:258: const flatTireCol = collection(db, 'flatTireAssignments');
modules/gameRulesManager.js:262: const snap = await getDocs(col);
modules/gameRulesManager.js:304: const snap = await getDocs(collection(db, colName));
modules/gameStateManager.js:15: onSnapshot,
modules/gameStateManager.js:196: const unsub = onSnapshot(gameStateRef, (docSnap) => {
modules/gameTimer.js:7: onSnapshot,
modules/gameTimer.js:148: onSnapshot(ref, (snap) => {
modules/homeMap.js:104: const snap = await getDocs(collection(db, 'zones'));
modules/playerBugStrikeUI.js:13: onSnapshot
modules/playerBugStrikeUI.js:48: bugStrikeUnsub = onSnapshot(q, (snapshot) => {
modules/playerUI/core.js:12: onSnapshot,
modules/playerUI/core.js:63: onSnapshot(qy, (snapshot) => {
modules/playerUI/core.js:100: onSnapshot(teamRef, async (docSnap) => {
modules/scoreboardManager.js:18: onSnapshot,
modules/scoreboardManager.js:90: const scoreSnaps = await getDocs(collection(db, 'scores'));
modules/scoreboardManager.js:100: const zoneSnaps = await getDocs(collection(db, 'zones'));
modules/scoreboardManager.js:129: onSnapshot(scoresCollection, (snapshot) => {
modules/scoreboardManager.js:166: const scoresSnap = await getDocs(collection(db, 'scores'));
modules/speedBump/comms.js:5: import { collection, onSnapshot, orderBy, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
modules/speedBump/comms.js:21: commsUnsub = onSnapshot(q, snapshot => {
modules/speedBumpManager_FULL.js:25: onSnapshot,
modules/speedBumpManager_FULL.js:53: commsUnsub = onSnapshot(commsQuery, snapshot => {
modules/teamSurpriseManager.js:13: onSnapshot,
modules/teamSurpriseManager.js:86: return onSnapshot(COLLECTION, snapshot => {
modules/teamSurpriseManager.js:159: return onSnapshot(ref, (snapshot) => {
modules/teamSurpriseManager.js:249: const snap = await getDocs(collection(db, 'teamSurprises'));
modules/zones.js:9: onSnapshot,
modules/zones.js:69: registerZoneListener('gameState', onSnapshot(doc(db, 'game', 'gameState'), (gameSnap) => {
modules/zones.js:92: registerZoneListener('zonesCollection', onSnapshot(zonesCollection, (snapshot) => {
modules/zones.js:189: const topTeamsSnap = await getDocs(
modules/zonesChallenge.js:109: const subSnap = await getDocs(collection(db, 'zones', zoneId, 'questions'));
components/FlatTireControl/controller/firestoreSync.js:4: import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
components/FlatTireControl/controller/firestoreSync.js:10: return onSnapshot(racersRef, snapshot => {
components/FlatTireControl/flatTireControlController_FULL.js:22: onSnapshot
components/FlatTireControl/flatTireControlController_FULL.js:236: return onSnapshot(racersRef, (snapshot) => {

ğŸ—ºï¸  Map Generation Flow
=======================
modules/googleMapsLoader.js:2: // modules/googleMapsLoader.js
modules/playerUI/overlays/flatTireOverlay.js:4: import { generateMiniMap } from '../../zonesMap.js';
modules/playerUI/overlays/flatTireOverlay.js:56: const mapHtml = generateMiniMap({ gps, diameter: diameterMeters / 1000 });
modules/playerUI/overlays_FULL.js:6: import { generateMiniMap } from '../zonesMap.js';
modules/playerUI/overlays_FULL.js:450: mapWrapper.innerHTML = generateMiniMap({
modules/zones.js:19: import { generateMiniMap } from './zonesMap.js';
modules/zones.js:109: <td>${generateMiniMap(zone)}</td>
modules/zonesMap.js:88: export function generateMiniMap(zoneData = {}) {
modules/zonesMap.js:107: const mapUrl = new URL('https://maps.googleapis.com/maps/api/staticmap');
modules/zonesMap.js:108: mapUrl.searchParams.set('center', `${lat},${lng}`);
modules/zonesMap.js:109: mapUrl.searchParams.set('zoom', zoomLevel);
modules/zonesMap.js:110: mapUrl.searchParams.set('size', '150x150');
modules/zonesMap.js:111: mapUrl.searchParams.set('maptype', 'satellite');
modules/zonesMap.js:112: mapUrl.searchParams.set('markers', `color:red|${lat},${lng}`);
modules/zonesMap.js:113: mapUrl.searchParams.set('key', firebaseConfig.apiKey);
modules/zonesMap.js:119: mapUrl.searchParams.append(
modules/zonesMap.js:125: mapUrl.searchParams.append(
modules/zonesMap.js:135: return `<img src="${mapUrl.toString()}" class="mini-map" alt="Map preview of ${label}">`;
components/FlatTireControl/flatTireControlController_FULL.js:18: import { generateMiniMap } from '../../modules/zonesMap.js';
components/FlatTireControl/flatTireControlController_FULL.js:380: map.innerHTML = generateMiniMap({

ğŸ›ï¸ Randomize Button Events
==========================
components/FlatTireControl/FlatTireControl.js:94: <button type="button" id="ft-randomize-zones-btn" class="${styles.secondaryBtn}">
components/FlatTireControl/flatTireControlController_FULL.js:73: randomizeBtn: null,
components/FlatTireControl/flatTireControlController_FULL.js:168: const randomizeBtn = document.getElementById('ft-randomize-zones-btn');
components/FlatTireControl/flatTireControlController_FULL.js:173: this.dom.randomizeBtn = randomizeBtn;
components/FlatTireControl/flatTireControlController_FULL.js:205: this.dom.randomizeBtn?.addEventListener('click', this.onRandomizeZones);
components/FlatTireControl/flatTireControlController_FULL.js:228: this.dom.randomizeBtn?.removeEventListener('click', this.onRandomizeZones);
components/FlatTireControl/flatTireControlController_FULL.js:463: await this.randomizeAssignedZones();
components/FlatTireControl/flatTireControlController_FULL.js:493: async randomizeAssignedZones() {
components/FlatTireControl/flatTireControlController_FULL.js:494: const button = this.dom.randomizeBtn;
components/FlatTireControl/flatTireControlController_FULL.js:497: alert('No teams available to randomize.');
components/FlatTireControl/flatTireControlController_FULL.js:521: return this.assignTeam(teamName, zoneKey, { cause: 'randomize' });
components/FlatTireControl/flatTireControlController_FULL.js:527: console.error('âŒ Flat Tire randomize failed:', err);
components/FlatTireControl/flatTireControlController_FULL.js:528: alert('Failed to randomize tow zones. Check console for details.');
components/FlatTireControl/flatTireControlController_FULL.js:638: if (this.dom.randomizeBtn) {
components/FlatTireControl/flatTireControlController_FULL.js:639: this.dom.randomizeBtn.disabled = !(hasTeams && hasZonesConfigured);

ğŸ“¡ GPS Field References
======================
components/FlatTireControl/FlatTireControl.js:34: <input type="text" class="${styles.gpsInput}" id="flat-tire-zone-gps-north" placeholder="45.0123,-93.1234" spellcheck="false" data-zone="north" />
components/FlatTireControl/FlatTireControl.js:47: <input type="text" class="${styles.gpsInput}" id="flat-tire-zone-gps-south" placeholder="44.9876,-93.2100" spellcheck="false" data-zone="south" />
components/FlatTireControl/FlatTireControl.js:60: <input type="text" class="${styles.gpsInput}" id="flat-tire-zone-gps-east" placeholder="44.9980,-93.0456" spellcheck="false" data-zone="east" />
components/FlatTireControl/FlatTireControl.js:73: <input type="text" class="${styles.gpsInput}" id="flat-tire-zone-gps-west" placeholder="45.0456,-93.2901" spellcheck="false" data-zone="west" />
components/FlatTireControl/controller/autoScheduler.js:28: const zoneKeys = Object.keys(controller.config.zones).filter(k => controller.config.zones[k].gps);
components/FlatTireControl/controller/autoScheduler.js:36: gps: zone.gps,
components/FlatTireControl/controller/domHandlers.js:14: dom.zoneInputs.set(key, document.getElementById(`flat-tire-zone-gps-${key}`));
components/FlatTireControl/controller/firestoreSync.js:33: if (input) input.value = zone.gps || '';
components/FlatTireControl/flatTireControlController_FULL.js:176: const input = document.getElementById(`flat-tire-zone-gps-${key}`);
components/FlatTireControl/flatTireControlController_FULL.js:288: if (input && input.value !== zone.gps) {
components/FlatTireControl/flatTireControlController_FULL.js:289: input.value = zone.gps || '';
components/FlatTireControl/flatTireControlController_FULL.js:339: gps: input?.value.trim() || '',
components/FlatTireControl/flatTireControlController_FULL.js:345: const coords = parseGps(updated.gps);
components/FlatTireControl/flatTireControlController_FULL.js:373: if (zone.gps) {
components/FlatTireControl/flatTireControlController_FULL.js:382: gps: zone.gps,
components/FlatTireControl/flatTireControlController_FULL.js:398: gps: input.value.trim()
components/FlatTireControl/flatTireControlController_FULL.js:426: const gpsInput = this.dom.zoneInputs.get(zoneKey);
components/FlatTireControl/flatTireControlController_FULL.js:439: gps: gpsInput?.value.trim() || '',
components/FlatTireControl/flatTireControlController_FULL.js:503: return zone && typeof zone.gps === 'string' && zone.gps.trim();
components/FlatTireControl/flatTireControlController_FULL.js:538: return zone && zone.gps;
components/FlatTireControl/flatTireControlController_FULL.js:599: if (!zone || !zone.gps) {
components/FlatTireControl/flatTireControlController_FULL.js:604: const coords = parseGps(zone.gps);
components/FlatTireControl/flatTireControlController_FULL.js:612: gps: zone.gps,
components/FlatTireControl/flatTireControlController_FULL.js:635: return zone && typeof zone.gps === 'string' && zone.gps.trim();
components/FlatTireControl/flatTireControlController_FULL.js:668: const disabled = zone?.gps ? '' : 'disabled';
modules/flatTireManager.js:30: north: { name: 'North Repair Depot', gps: '', diameterMeters: DEFAULT_DIAMETER_METERS },
modules/flatTireManager.js:31: south: { name: 'South Repair Depot', gps: '', diameterMeters: DEFAULT_DIAMETER_METERS },
modules/flatTireManager.js:32: east: { name: 'East Repair Depot', gps: '', diameterMeters: DEFAULT_DIAMETER_METERS },
modules/flatTireManager.js:33: west: { name: 'West Repair Depot', gps: '', diameterMeters: DEFAULT_DIAMETER_METERS }
modules/flatTireManager.js:49: function parseGpsString(gps = '') {
modules/flatTireManager.js:50: if (typeof gps !== 'string') return null;
modules/flatTireManager.js:51: const [latStr, lngStr] = gps.split(',');
modules/flatTireManager.js:58: export function getDistanceMetersToDepot(gps = '', position = {}) {
modules/flatTireManager.js:59: const center = parseGpsString(gps);
modules/flatTireManager.js:67: export function isWithinCaptureRadius(gps = '', position = {}) {
modules/flatTireManager.js:68: const distanceMeters = getDistanceMetersToDepot(gps, position);
modules/flatTireManager.js:84: const parsedGps = parseGpsString(options.gps);
modules/flatTireManager.js:109: gps: options.gps || '',
modules/flatTireManager.js:134: const safeGps = typeof zone.gps === 'string' ? zone.gps.trim() : '';
modules/flatTireManager.js:147: gps: safeGps,

âœ… Summary
=========
Check import paths for ../../modules/zonesMap.js, ../../modules/zonesFirestore.js, and ensure flatTireManager.js exports subscribeFlatTireAssignments().
